<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>辦公室下午茶點單系統 - 管理版</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .glass-morphism { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        body { background: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom';
        import { 
            Coffee, Plus, Trash2, Edit3, Settings, LogIn, X, 
            CheckCircle, ChevronRight, BarChart2, FileDown, ShieldCheck, 
            Image as ImageIcon, Loader2, Save, ShoppingBag
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, onSnapshot, writeBatch } from 'firebase/firestore';

        // --- 設定區 ---
        const LIFF_ID = "2008746387-2t2kxxUX";
        const firebaseConfig = {
            apiKey: "AIzaSyBJeC5O1DF2VpvoSE8OKjtPT4wYPYec-Ok",
            authDomain: "office-tea-time.firebaseapp.com",
            projectId: "office-tea-time",
            storageBucket: "office-tea-time.firebasestorage.app",
            messagingSenderId: "771203264362",
            appId: "1:771203264362:web:cd47393dd73578b6ebbf13",
            measurementId: "G-R5SV13TYTE"
        };
        const GOOGLE_AI_API_KEY = ""; // TODO: 填入你的 API Key

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'office-tea-system';

        const LoadingSpinner = () => (
            <div className="flex flex-col items-center justify-center p-12">
                <Loader2 className="w-10 h-10 animate-spin text-blue-500 mb-2" />
                <p className="text-gray-500">正在解析菜單，這可能需要幾秒鐘...</p>
            </div>
        );

        function App() {
            const [user, setUser] = useState(null);
            const [lineProfile, setLineProfile] = useState(null);
            const [stores, setStores] = useState([]);
            const [orders, setOrders] = useState([]);
            const [view, setView] = useState('home'); 
            const [selectedStore, setSelectedStore] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);

            useEffect(() => {
                const initApp = async () => {
                    try {
                        if (typeof liff !== 'undefined') {
                            await liff.init({ liffId: LIFF_ID });
                            if (liff.isLoggedIn()) {
                                const profile = await liff.getProfile();
                                setLineProfile(profile);
                            }
                        }
                    } catch (err) { console.error("LIFF Error", err); }
                    try { await signInAnonymously(auth); } catch (e) {}
                };
                initApp();
                return onAuthStateChanged(auth, (u) => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                const unsubStores = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'stores'), (s) => 
                    setStores(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                const unsubOrders = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (s) => 
                    setOrders(s.docs.map(d => ({ id: d.id, ...d.data() }))));
                return () => { unsubStores(); unsubOrders(); };
            }, [user]);

            // --- AI 多圖解析功能 ---
            const parseMenuWithAI = async (text, images = []) => {
                if (!GOOGLE_AI_API_KEY) return alert("請先填入 Google AI API Key");
                setIsLoading(true);
                try {
                    const systemPrompt = `你是一個菜單解析專家。請從提供的文字或多張圖片中提取餐飲店家資訊。
                    請回傳 JSON 格式：{"storeName": "店名", "items": [{"name": "品項", "price": 50}], "options": {"ice": ["正常", "去冰"], "sugar": ["全糖", "無糖"]}, "addons": []}
                    請確保彙整所有圖片中的品項。`;

                    let parts = [{ text: text || "請解析附件圖片中的菜單內容" }];
                    
                    // 將多張圖片加入請求
                    images.forEach(base64 => {
                        parts.push({
                            inlineData: { mimeType: "image/png", data: base64.split(',')[1] }
                        });
                    });

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_AI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: parts }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    const result = await response.json();
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stores'), {
                        ...data,
                        createdAt: Date.now(),
                        settings: { showSugar: true, showIce: true, showNote: true }
                    });
                    alert("店家建立成功！");
                    setView('home');
                } catch (err) {
                    console.error(err);
                    alert("AI 解析失敗，請檢查 API Key 或網路狀態。");
                } finally {
                    setIsLoading(false);
                }
            };

            // --- 視圖: 首頁 ---
            const HomeView = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <Coffee className="text-orange-500" /> 店家清單
                        </h2>
                        <div className="flex gap-2">
                            {/* 管理員按鈕現在永遠顯示 */}
                            <button onClick={() => setView('admin')} className="p-2 bg-white shadow-sm border rounded-full hover:bg-gray-100 transition-colors">
                                <Settings className="w-6 h-6 text-gray-600" />
                            </button>
                            {!lineProfile ? (
                                <button onClick={() => liff.login()} className="px-4 py-2 bg-[#06C755] text-white rounded-full text-sm font-bold shadow-md">LINE 登入</button>
                            ) : (
                                <img src={lineProfile.pictureUrl} className="w-10 h-10 rounded-full border-2 border-white shadow-sm" title={lineProfile.displayName} />
                            )}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {stores.map(store => (
                            <div key={store.id} onClick={() => { setSelectedStore(store); setView('store-detail'); }} className="glass-morphism p-5 rounded-3xl cursor-pointer hover:shadow-xl transition-all border-b-4 border-orange-100">
                                <h3 className="text-xl font-bold text-gray-800 mb-2">{store.storeName}</h3>
                                <p className="text-sm text-gray-500">{store.items?.length || 0} 個品項 • {orders.filter(o => o.storeId === store.id).length} 筆點單</p>
                            </div>
                        ))}
                    </div>
                    <button onClick={() => setView('stats')} className="fixed bottom-6 right-6 p-4 bg-orange-500 text-white rounded-full shadow-lg"><BarChart2 /></button>
                </div>
            );

            // --- 視圖: 管理員介面 ---
            const AdminView = () => {
                const [pwd, setPwd] = useState('');
                const [isAuthed, setIsAuthed] = useState(isAdmin);
                const [menuInput, setMenuInput] = useState('');
                const [imageFiles, setImageFiles] = useState([]);

                const handleFileSelect = (e) => {
                    const files = Array.from(e.target.files);
                    const readers = files.map(file => new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    }));
                    Promise.all(readers).then(setImageFiles);
                };

                if (!isAuthed) return (
                    <div className="max-w-md mx-auto mt-20 p-8 bg-white rounded-3xl shadow-sm border text-center">
                        <ShieldCheck className="mx-auto w-12 h-12 text-blue-500 mb-4" />
                        <h2 className="text-xl font-bold mb-4">管理員驗證</h2>
                        <input type="password" value={pwd} onChange={e=>setPwd(e.target.value)} placeholder="請輸入密碼 (8888)" className="w-full p-3 border rounded-xl mb-4 text-center" />
                        <button onClick={() => pwd==='8888'?(setIsAuthed(true), setIsAdmin(true)):alert('密碼錯誤')} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">登入系統</button>
                        <button onClick={()=>setView('home')} className="mt-4 text-gray-400 text-sm">返回首頁</button>
                    </div>
                );

                return (
                    <div className="max-w-2xl mx-auto space-y-6 pb-20">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">管理控制台</h2>
                            <button onClick={()=>setView('home')}><X /></button>
                        </div>
                        
                        <div className="bg-white p-6 rounded-3xl shadow-sm border space-y-4">
                            <h3 className="font-bold flex items-center gap-2"><ImageIcon size={18}/> AI 智慧建立 (支援多圖)</h3>
                            <textarea value={menuInput} onChange={e=>setMenuInput(e.target.value)} placeholder="可貼上菜單文字內容..." className="w-full p-4 bg-gray-50 rounded-2xl min-h-[100px] outline-none" />
                            
                            <label className="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 rounded-2xl p-6 cursor-pointer hover:bg-gray-50 transition-colors">
                                <ImageIcon className="text-gray-400 mb-2" />
                                <span className="text-gray-500 text-sm">{imageFiles.length > 0 ? `已選取 ${imageFiles.length} 張圖片` : '點擊選取或拖放多張菜單照片'}</span>
                                <input type="file" multiple accept="image/*" onChange={handleFileSelect} className="hidden" />
                            </label>

                            <button 
                                onClick={() => parseMenuWithAI(menuInput, imageFiles)} 
                                disabled={isLoading || (!menuInput && imageFiles.length === 0)}
                                className="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold disabled:opacity-50 shadow-lg shadow-blue-100"
                            >
                                {isLoading ? '正在分析中...' : '開始 AI 解析並建立店家'}
                            </button>
                        </div>

                        <div className="bg-white p-6 rounded-3xl border">
                            <h3 className="font-bold mb-4">店家管理</h3>
                            {stores.map(s => (
                                <div key={s.id} className="flex justify-between items-center py-3 border-b last:border-0">
                                    <span>{s.storeName}</span>
                                    <button onClick={async () => { if(confirm('確定刪除？')) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stores', s.id)) }} className="text-red-400"><Trash2 size={18}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // --- 其他視圖 (簡化邏輯供運行) ---
            const StoreDetailView = () => (
                <div className="max-w-2xl mx-auto space-y-6 pb-20">
                    <button onClick={()=>setView('home')} className="text-gray-400 flex items-center gap-1"><ChevronRight className="rotate-180"/> 返回</button>
                    <div className="bg-white p-6 rounded-3xl shadow-sm border">
                        <h2 className="text-2xl font-bold mb-6">{selectedStore?.storeName}</h2>
                        {selectedStore?.items.map((item, i) => (
                            <div key={i} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl mb-2">
                                <span>{item.name} <span className="text-gray-400 text-sm ml-2">${item.price}</span></span>
                                <button onClick={async () => {
                                    if(!lineProfile) return setShowAuthModal(true);
                                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                                        storeId: selectedStore.id, storeName: selectedStore.storeName, itemName: item.name, price: item.price,
                                        userName: lineProfile.displayName, userPic: lineProfile.pictureUrl, createdAt: Date.now()
                                    });
                                    alert('已加入點單！');
                                }} className="p-2 bg-orange-500 text-white rounded-lg"><Plus size={18}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const StatsView = () => (
                <div className="max-w-2xl mx-auto space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">訂單彙整</h2>
                        <button onClick={()=>setView('home')}><X/></button>
                    </div>
                    <div className="bg-white p-6 rounded-3xl border space-y-4">
                        <div className="flex justify-between text-lg font-bold">
                            <span>總金額：${orders.reduce((a,b)=>a+(b.price||0),0)}</span>
                            <span>總杯數：{orders.length} 杯</span>
                        </div>
                        {orders.map((o,i)=>(
                            <div key={i} className="flex items-center gap-3 p-2 border-b">
                                <img src={o.userPic} className="w-8 h-8 rounded-full" />
                                <span className="flex-1">{o.userName}：{o.itemName}</span>
                                <span className="font-mono">${o.price}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto">
                    <header className="mb-8">
                        <h1 className="text-3xl font-black text-gray-800 flex items-center gap-3">
                            <div className="bg-orange-500 text-white p-2 rounded-2xl shadow-lg"><Coffee /></div>
                            下午茶大隊
                        </h1>
                    </header>
                    {isLoading ? <LoadingSpinner /> : (
                        <>
                            {view === 'home' && <HomeView />}
                            {view === 'store-detail' && <StoreDetailView />}
                            {view === 'admin' && <AdminView />}
                            {view === 'stats' && <StatsView />}
                        </>
                    )}
                    {showAuthModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-[40px] text-center max-w-sm">
                                <h3 className="text-2xl font-bold mb-4">請先登入</h3>
                                <p className="text-gray-500 mb-6">點單功能需要 LINE 登入以記錄身分。</p>
                                <button onClick={()=>{liff.login(); setShowAuthModal(false)}} className="w-full py-4 bg-[#06C755] text-white rounded-2xl font-bold">使用 LINE 登入</button>
                                <button onClick={()=>setShowAuthModal(false)} className="mt-4 text-gray-400">取消</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
