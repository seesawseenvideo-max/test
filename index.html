import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Plus, Trash2, Coffee, Download, Users, List, Settings, 
  ShoppingBag, X, ChefHat, Check, Upload, Image as ImageIcon, 
  Loader2, Sparkles, Edit, Save, AlertTriangle, PenLine, Wifi, WifiOff, Lock, LogOut,
  Minus, Info, ExternalLink, Search, Square, CheckSquare, Eye, EyeOff, RotateCcw,
  ArrowRightLeft, FileSearch, CheckCircle2, AlertCircle
} from 'lucide-react';

import { signInAnonymously, onAuthStateChanged, User as FirebaseUser } from 'firebase/auth';
import { collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from 'firebase/firestore';
import { auth, db } from './services/firebase';
import { parseMenuWithGemini, auditMenuWithGemini } from './services/geminiService';
import { Store, Order, Item, Topping, AuditResult } from './types';

// Declare global LIFF variable
declare const liff: any;

const LIFF_ID = "2008729022-PSf5NFFI";
const APP_ARTIFACT_ID = 'my-office-tea-v1';

const DEFAULT_SUGAR = ['正常糖', '少糖', '半糖', '微糖', '無糖', '無'];
const DEFAULT_ICE = ['正常冰', '少冰', '微冰', '去冰', '溫', '熱', '無'];

const Toast = ({ message, type, onClose }: { message: string, type: 'success' | 'error' | 'info', onClose: () => void }) => {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);
  
  const bgColors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
  
  return (
    <div className={`fixed bottom-4 right-4 ${bgColors[type] || 'bg-gray-800'} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-bounce-in z-50`}>
      <span>{message}</span>
    </div>
  );
};

export default function App() {
  const [liffLoading, setLiffLoading] = useState(true);
  const [lineProfile, setLineProfile] = useState<any>(null);
  const [user, setUser] = useState<FirebaseUser | null>(null);
  const [isOnline, setIsOnline] = useState(false);
  const [view, setView] = useState('order'); 
  const [stores, setStores] = useState<Store[]>([]); 
  const [orders, setOrders] = useState<Order[]>([]); 
  const [currentUser, setCurrentUser] = useState('');
  const [selectedStoreId, setSelectedStoreId] = useState<string | null>(null);
  const [cartItem, setCartItem] = useState<Item | null>(null); 
  const [toast, setToast] = useState<{message: string, type: 'success'|'error'|'info'} | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [newStoreName, setNewStoreName] = useState('');
  const [newStoreDescription, setNewStoreDescription] = useState('');
  const [newStoreUrl, setNewStoreUrl] = useState('');
  const [menuInputText, setMenuInputText] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [editingStore, setEditingStore] = useState<Store | null>(null);
  const [storeToDelete, setStoreToDelete] = useState<Store | null>(null);
  const [showClearConfirm, setShowClearConfirm] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [showAdminLogin, setShowAdminLogin] = useState(false);
  const [adminPasswordInput, setAdminPasswordInput] = useState('');
  const [sugar, setSugar] = useState('正常糖');
  const [ice, setIce] = useState('正常冰');
  const [customNote, setCustomNote] = useState('');
  const [count, setCount] = useState(1);
  const [customItemName, setCustomItemName] = useState('');
  const [customItemPrice, setCustomItemPrice] = useState('');
  const [selectedToppings, setSelectedToppings] = useState<Topping[]>([]);
  const [editingOrderId, setEditingOrderId] = useState<string | null>(null);
  // New state for individual item notes
  const [individualItemNotes, setIndividualItemNotes] = useState<string[]>(['']);

  // Audit State
  const [auditText, setAuditText] = useState('');
  const [isAuditing, setIsAuditing] = useState(false);
  const [auditResult, setAuditResult] = useState<AuditResult | null>(null);

  const showToast = (msg: string, type: 'success'|'error'|'info' = 'success') => setToast({ message: msg, type });

  // Init LIFF
  useEffect(() => {
    const initLiff = async () => {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          setLineProfile(profile);
          setCurrentUser(profile.displayName);
          setLiffLoading(false);
        }
      } catch (err) {
        console.error('LIFF Init Error:', err);
        setLiffLoading(false);
      }
    };
    initLiff();
  }, []);

  // Init Firebase Auth
  const authInitiated = useRef(false);
  useEffect(() => {
    if (!auth || authInitiated.current) return;
    authInitiated.current = true;
    const initAuth = async () => {
      if (auth.currentUser) {
        setUser(auth.currentUser);
        setIsOnline(true);
        return;
      }
      try { 
        await signInAnonymously(auth); 
      } catch (error: any) { 
        if (error.code !== 'auth/too-many-requests') console.error("Auth Error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setIsOnline(!!u);
    });
    return () => unsubscribe();
  }, []);

  // Load Data
  useEffect(() => {
    if (!user || !db) return;
    const storesQuery = query(collection(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'stores'));
    const unsubStores = onSnapshot(storesQuery, (snapshot) => {
      const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Store));
      loaded.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
      setStores(loaded);
      if (loaded.length > 0) {
        setSelectedStoreId(prev => loaded.find(s => s.id === prev) ? prev : loaded[0].id);
      }
    });
    const ordersQuery = query(collection(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'orders'));
    const unsubOrders = onSnapshot(ordersQuery, (snapshot) => {
      const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() } as Order));
      loaded.sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());
      setOrders(loaded);
    });
    return () => { unsubStores(); unsubOrders(); };
  }, [user]);

  // Reset cart options when item changes
  useEffect(() => {
    if (cartItem && !editingOrderId) {
      setCount(1);
      setCustomNote('');
      setSelectedToppings([]);
      setIndividualItemNotes(['']); // Reset individual notes
      const store = stores.find(s => s.id === selectedStoreId);
      setSugar(store?.sugarOptions?.[0] || '正常糖');
      setIce(store?.iceOptions?.[0] || '正常冰');
    }
  }, [cartItem, selectedStoreId, stores, editingOrderId]);

  // Sync individual notes array with count
  useEffect(() => {
    setIndividualItemNotes(prev => {
      if (prev.length === count) return prev;
      const next = [...prev];
      if (count > prev.length) {
        // Add empty strings for new items
        while (next.length < count) next.push('');
      } else {
        // Trim array if count decreases
        while (next.length > count) next.pop();
      }
      return next;
    });
  }, [count]);

  const parsePrice = (v: any) => typeof v === 'number' ? v : (parseFloat(String(v).match(/[0-9.]+/)?.[0] || '0') || 0);

  const handleAIParse = async (mode: 'text' | 'image', files: FileList | null = null) => {
    if (!newStoreName.trim()) return showToast('請輸入店家名稱', 'error');
    if (mode === 'text' && !menuInputText.trim()) return showToast('請填寫文字', 'error');
    
    setIsAnalyzing(true);
    showToast('AI 分析中...', 'info');
    
    try {
      let imageBase64Data: string[] = [];
      
      if (mode === 'image' && files) {
        imageBase64Data = await Promise.all(Array.from(files).map(f => new Promise<string>((res, rej) => {
          const r = new FileReader();
          r.onload = () => res((r.result as string).split(',')[1]);
          r.readAsDataURL(f);
        })));
      }

      const query = mode === 'image' ? "分析菜單圖片" : `分析內容：\n${menuInputText}`;
      const result = await parseMenuWithGemini(query, imageBase64Data);

      const tempStore: Store = {
        id: 'temp-new',
        name: newStoreName, 
        description: newStoreDescription, 
        url: newStoreUrl,
        items: (result.items || []).map((it: any, i: number) => ({ id: `ai-${Date.now()}-${i}`, name: it.name || "未命名", price: parsePrice(it.price), noSugar: false, noIce: false, allowNote: true })),
        toppings: (result.toppings || []).map((t: any, i: number) => ({ id: `ai-t-${Date.now()}-${i}`, name: t.name || "加料", price: parsePrice(t.price)})),
        sugarOptions: result.sugarOptions?.length ? result.sugarOptions : DEFAULT_SUGAR,
        iceOptions: result.iceOptions?.length ? result.iceOptions : DEFAULT_ICE,
        createdAt: Date.now()
      };
      
      const editState = JSON.parse(JSON.stringify(tempStore));
      editState.sugarStr = editState.sugarOptions.join(',');
      editState.iceStr = editState.iceOptions.join(',');
      setEditingStore(editState);
      
      setNewStoreName(''); setNewStoreDescription(''); setNewStoreUrl(''); setMenuInputText('');
      showToast('辨識完成');
    } catch (e: any) { 
      showToast(`失敗: ${e.message}`, 'error'); 
    } finally { 
      setIsAnalyzing(false); 
    }
  };

  const handleMenuAudit = async () => {
    if (!auditText.trim()) return showToast('請貼上網頁文字內容', 'error');
    if (!editingStore) return;

    setIsAuditing(true);
    showToast('正在與現有菜單進行比對...', 'info');
    try {
      const currentItems = editingStore.items.map(i => ({ name: i.name, price: i.price }));
      const result = await auditMenuWithGemini(currentItems, auditText);
      setAuditResult(result);
      showToast('查核完成，請確認差異');
    } catch (e) {
      showToast('比對失敗', 'error');
    } finally {
      setIsAuditing(false);
    }
  };

  const applyAuditItem = (item: any, type: 'add' | 'remove') => {
    if (!editingStore) return;
    if (type === 'add') {
      setEditingStore(p => p ? ({
        ...p,
        items: [...p.items, { id: `audit-${Date.now()}`, name: item.name, price: Number(item.price), noSugar: false, noIce: false, allowNote: true }]
      }) : null);
      setAuditResult(p => p ? ({ ...p, added: p.added.filter(x => x.name !== item.name) }) : null);
    } else if (type === 'remove') {
      setEditingStore(p => p ? ({
        ...p,
        items: p.items.filter(x => x.name !== item.name)
      }) : null);
      setAuditResult(p => p ? ({ ...p, removed: p.removed.filter(x => x.name !== item.name) }) : null);
    }
  };

  const saveStoreChanges = async () => {
    if (!user || !db || !editingStore) return showToast('尚未連線', 'error');
    if (!editingStore.name.trim()) return showToast('名稱不能為空', 'error');
    try {
      const sOpt = (editingStore.sugarStr || '').split(/[,\s，、]+/).map(s => s.trim()).filter(Boolean);
      const iOpt = (editingStore.iceStr || '').split(/[,\s，、]+/).map(s => s.trim()).filter(Boolean);
      const storeData = {
        name: editingStore.name, description: editingStore.description || '', url: editingStore.url || '',
        items: editingStore.items || [], toppings: editingStore.toppings || [],
        sugarOptions: sOpt.length ? sOpt : DEFAULT_SUGAR, iceOptions: iOpt.length ? iOpt : DEFAULT_ICE, updatedAt: Date.now()
      };
      if (editingStore.id === 'temp-new') {
        await addDoc(collection(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'stores'), { ...storeData, createdAt: Date.now() });
      } else {
        await updateDoc(doc(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'stores', editingStore.id), storeData);
      }
      setEditingStore(null); 
      setAuditResult(null);
      setAuditText('');
      showToast('儲存成功');
    } catch (e) { showToast('儲存失敗', 'error'); }
  };

  const confirmDeleteStore = async () => {
    if (!storeToDelete || !user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'stores', storeToDelete.id));
      setStoreToDelete(null); showToast('店家已刪除');
    } catch (e) { showToast('刪除失敗', 'error'); }
  };

  const handleClearOrders = async () => {
    if (!isAdmin || !user) return;
    try {
      const deletePromises = orders.map(order => 
        deleteDoc(doc(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'orders', order.id))
      );
      await Promise.all(deletePromises);
      setShowClearConfirm(false);
      showToast('已清除所有訂單');
    } catch (e) {
      showToast('清除失敗', 'error');
    }
  };

  const updateEditingItem = (id: string, f: keyof Item, v: any) => 
    setEditingStore(p => p ? ({ ...p, items: p.items.map(i => i.id === id ? { ...i, [f]: f === 'price' ? Number(v) : v } : i) }) : null);
  
  const batchToggleItems = (field: 'noSugar' | 'noIce', value: boolean) => 
    setEditingStore(p => p ? ({ ...p, items: (p.items || []).map(i => ({ ...i, [field]: value })) }) : null);
  
  const addEmptyItemToEditing = () => 
    setEditingStore(p => p ? ({ ...p, items: [...(p.items || []), { id: `m-${Date.now()}`, name: '', price: 0, noSugar: false, noIce: false, allowNote: true }] }) : null);
  
  const removeItemFromEditing = (id: string) => 
    setEditingStore(p => p ? ({ ...p, items: p.items.filter(i => i.id !== id) }) : null);
  
  const updateEditingTopping = (id: string, f: keyof Topping, v: any) => 
    setEditingStore(p => p ? ({ ...p, toppings: (p.toppings || []).map(t => t.id === id ? { ...t, [f]: f === 'price' ? Number(v) : v } : t) }) : null);
  
  const addToppingToEditing = () => 
    setEditingStore(p => p ? ({ ...p, toppings: [...(p.toppings || []), { id: `t-${Date.now()}`, name: '', price: 0 }] }) : null);
  
  const removeToppingFromEditing = (id: string) => 
    setEditingStore(p => p ? ({ ...p, toppings: p.toppings.filter(t => t.id !== id) }) : null);
  
  const openEditStore = (store: Store) => {
    const editState = JSON.parse(JSON.stringify(store));
    editState.sugarStr = (editState.sugarOptions || DEFAULT_SUGAR).join(',');
    editState.iceStr = (editState.iceOptions || DEFAULT_ICE).join(',');
    setEditingStore(editState);
    setAuditResult(null);
    setAuditText('');
  };

  const handleAddToCart = async () => {
    if (!currentUser) return showToast('未取得 LINE 名稱', 'error');
    if (!cartItem) return;
    let name = cartItem.isCustom ? customItemName : cartItem.name;
    let price = Number(cartItem.isCustom ? customItemPrice : cartItem.price);
    if (!name || isNaN(price)) return showToast('資訊不完整', 'error');
    try {
      const tNames = selectedToppings.map(t => `+${t.name}`).join(' ');
      const tPrice = selectedToppings.reduce((s, t) => s + Number(t.price || 0), 0);
      const finalUnitPrice = price + tPrice;
      
      // If editing existing order
      if (editingOrderId) {
        // Use first individual note or custom note
        const itemNote = individualItemNotes[0] || '';
        const finalNote = [(!cartItem.noSugar ? sugar : ''), (!cartItem.noIce ? ice : ''), tNames, itemNote, customNote].filter(Boolean).join(' ');
        
        await updateDoc(doc(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'orders', editingOrderId), { item: { name }, note: finalNote, price: finalUnitPrice });
        setEditingOrderId(null);
      } else {
        // Adding new orders (batch support)
        const batch: Promise<any>[] = [];
        for (let i = 0; i < count; i++) {
          // Combine: Sugar/Ice + Toppings + Specific Item Note + Global Custom Note
          const specificNote = individualItemNotes[i] || '';
          const finalNote = [
            (!cartItem.noSugar ? sugar : ''), 
            (!cartItem.noIce ? ice : ''), 
            tNames, 
            specificNote,
            customNote
          ].filter(Boolean).join(' ');

          batch.push(addDoc(collection(db, 'artifacts', APP_ARTIFACT_ID, 'public', 'data', 'orders'), {
            userName: currentUser, storeId: selectedStoreId, storeName: stores.find(s => s.id === selectedStoreId)?.name,
            item: { name }, note: finalNote, price: finalUnitPrice, timestamp: new Date().toISOString()
          }));
        }
        await Promise.all(batch);
      }
      setCartItem(null); showToast('已送出');
    } catch (e) { showToast("失敗", "error"); }
  };

  const handleEditOrder = (order: Order) => {
    const store = stores.find(s => s.id === order.storeId);
    let item = store?.items?.find(i => i.name === order.item.name) || { id: 'custom-edit', name: order.item.name, price: order.price, isCustom: true };
    setCartItem(item); setSelectedStoreId(order.storeId); setEditingOrderId(order.id);
    if (item.isCustom) { setCustomItemName(item.name); setCustomItemPrice(String(order.price)); }
  };

  const handleLogout = () => { liff.logout(); window.location.reload(); };

  const stats = useMemo(() => {
    const uT: Record<string, {name: string, total: number, items: Order[]}> = {}; 
    const iT: Record<string, {storeName: string, itemName: string, count: number, details: Record<string, number>}> = {}; 
    let total = 0;
    orders.forEach(o => {
      total += o.price;
      if (!uT[o.userName]) uT[o.userName] = { name: o.userName, total: 0, items: [] };
      uT[o.userName].total += o.price; uT[o.userName].items.push(o);
      const k = `${o.storeName}-${o.item.name}`;
      if (!iT[k]) iT[k] = { storeName: o.storeName, itemName: o.item.name, count: 0, details: {} };
      iT[k].count++; iT[k].details[o.note || '無'] = (iT[k].details[o.note || '無'] || 0) + 1;
    });
    return { userTotals: uT, itemStats: iT, totalAmount: total };
  }, [orders]);

  const exportCSV = () => {
    const bom = "\uFEFF";
    let csvContent = bom + "姓名,店家,品項,單價,備註,下單時間\n";
    orders.forEach(order => {
      csvContent += [order.userName, order.storeName, order.item.name, order.price, `"${order.note || ''}"`, new Date(order.timestamp).toLocaleString()].join(",") + "\n";
    });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
    link.download = `下午茶點單_${new Date().toLocaleDateString()}.csv`;
    link.click();
  };

  const handleAdminLogin = () => {
    if (adminPasswordInput === '8888') {
      setIsAdmin(true); setShowAdminLogin(false); setView('admin'); showToast('登入成功');
    } else showToast('密碼錯誤', 'error');
  };

  const currentStore = stores.find(s => s.id === selectedStoreId);
  const currentSugarOptions = currentStore?.sugarOptions || DEFAULT_SUGAR;
  const currentIceOptions = currentStore?.iceOptions || DEFAULT_ICE;
  const currentToppings = currentStore?.toppings || [];
  const estimatedPrice = cartItem ? (((Number(cartItem.isCustom ? customItemPrice : (cartItem.price || 0))) + selectedToppings.reduce((sum, t) => sum + Number(t.price || 0), 0)) * count) : 0;

  if (liffLoading) return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-teal-50 text-center p-6">
      <Loader2 className="animate-spin text-teal-600 mb-4" size={48} />
      <p className="text-teal-800 font-bold">LINE 身份驗證中...</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 pb-20 md:pb-0 font-sans leading-relaxed">
      <header className={`text-white p-4 shadow-md sticky top-0 z-10 transition-colors ${isOnline ? 'bg-teal-600' : 'bg-gray-600'}`}>
        <div className="max-w-4xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3">
            {lineProfile?.pictureUrl ? <img src={lineProfile.pictureUrl} className="w-10 h-10 rounded-full border-2 border-white/50" alt="avatar" /> : <Coffee size={24}/>}
            <div>
              <h1 className="text-lg font-bold leading-none">{lineProfile?.displayName || '下午茶系統'}</h1>
              <span className="text-[10px] opacity-80 uppercase tracking-widest font-mono">Office Dashboard</span>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="text-sm bg-white/20 px-3 py-1 rounded-full whitespace-nowrap backdrop-blur-sm">今日總額: ${stats.totalAmount}</div>
            <button onClick={handleLogout} className="p-2 hover:bg-white/10 rounded-full transition-colors"><LogOut size={18}/></button>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4">
        <div className="flex gap-2 mb-6 bg-white p-1 rounded-lg shadow-sm border border-gray-200">
          {['order', 'stats', 'admin'].map(v => (
            <button key={v} onClick={() => (v==='admin' && !isAdmin) ? setShowAdminLogin(true) : setView(v)} className={`flex-1 py-2 px-4 rounded-md flex items-center justify-center gap-2 transition-colors ${view===v ? 'bg-teal-100 text-teal-700 font-bold' : 'text-gray-500 hover:bg-gray-50'}`}>
              {v==='order' && <><ShoppingBag size={18}/> <span className="hidden sm:inline">點餐</span></>}
              {v==='stats' && <><List size={18}/> <span className="hidden sm:inline">統計</span></>}
              {v==='admin' && <><Settings size={18}/> <span className="hidden sm:inline">管理</span></>}
            </button>
          ))}
        </div>

        {view === 'order' && (
          <div className="space-y-6 animate-fade-in">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4">
              <div className="bg-teal-50 p-3 rounded-lg text-teal-600"><Users size={24}/></div>
              <div className="flex-1">
                <label className="block text-xs text-gray-400">目前點餐身分</label>
                <input type="text" value={currentUser} readOnly className="w-full font-bold text-lg bg-transparent text-gray-800 outline-none" />
              </div>
              <span className="text-[10px] text-teal-600 font-bold bg-teal-50 px-2 py-1 rounded border border-teal-100">驗證成功</span>
            </div>

            {stores.length > 0 ? (
              <>
                <div className="flex overflow-x-auto gap-2 mb-4 pb-2 scrollbar-hide">
                  {stores.map(s => <button key={s.id} onClick={() => setSelectedStoreId(s.id)} className={`whitespace-nowrap px-4 py-2 rounded-full border transition-all ${selectedStoreId === s.id ? 'bg-teal-600 text-white shadow-md border-teal-600 scale-105' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>{s.name}</button>)}
                </div>
                
                {currentStore && (currentStore.description || currentStore.url) && (
                  <div className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm space-y-2 mb-4 animate-fade-in">
                    {currentStore.description && <div className="text-gray-600 text-sm flex items-start gap-2"><Info size={16} className="mt-0.5 text-teal-500 shrink-0"/><p>{currentStore.description}</p></div>}
                    {currentStore.url && <a href={currentStore.url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-2 text-teal-600 text-sm font-bold bg-teal-50 px-2 py-1 rounded hover:underline"><ExternalLink size={16}/>開啟菜單網址</a>}
                  </div>
                )}
                
                <div className="relative mb-4">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/>
                  <input type="text" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} placeholder="搜尋品項..." className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition-all shadow-sm" />
                </div>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <button onClick={()=>setCartItem({id:'custom', name: '', price: 0, isCustom:true})} className="flex flex-col items-center justify-center p-4 bg-teal-50 border-2 border-dashed border-teal-300 rounded-xl text-teal-700 gap-2 min-h-[100px] hover:bg-teal-100 transition-colors shadow-sm"><PenLine size={24}/>自訂</button>
                  {(currentStore?.items || []).filter(i=>(i.name || '').toLowerCase().includes(searchTerm.toLowerCase())).map(item => (
                    <button key={item.id} onClick={()=>setCartItem(item)} className="p-4 bg-white border rounded-xl hover:shadow-md hover:border-teal-300 text-left group min-h-[100px] transition-all relative overflow-hidden">
                      <span className="font-bold text-gray-800 line-clamp-2 leading-snug">{item.name}</span>
                      <span className="text-gray-500 text-sm mt-1 inline-block">${item.price}</span>
                      <div className="mt-2 flex justify-end"><Plus size={16} className="text-teal-600 bg-teal-50 rounded-full p-0.5"/></div>
                    </button>
                  ))}
                </div>
              </>
            ) : <div className="text-center py-10 bg-white rounded-xl border-dashed border text-gray-400 text-sm">目前無店家，請由管理頁面新增</div>}
          </div>
        )}

        {view === 'stats' && (
          <div className="space-y-6 animate-fade-in">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="bg-gradient-to-br from-teal-500 to-teal-700 text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
                <Coffee className="absolute -right-4 -bottom-4 text-white/10 w-32 h-32 rotate-12" />
                <h3 className="text-teal-100 text-sm font-medium mb-1">今日總金額</h3>
                <div className="text-4xl font-bold">${stats.totalAmount}</div>
                <p className="mt-2 text-xs opacity-80">共有 {Object.keys(stats.userTotals).length} 位成員訂購</p>
              </div>
              <div className="flex flex-col gap-2">
                <button onClick={exportCSV} disabled={orders.length === 0} className={`bg-white p-4 rounded-xl border flex flex-col items-center justify-center transition-all flex-1 shadow-sm ${orders.length===0?'opacity-50 grayscale':'hover:bg-gray-50 text-teal-600'}`}>
                  <Download size={24}/><span className="mt-1 font-bold text-sm">匯出明細表</span>
                </button>
                {isAdmin && (
                  <button onClick={()=>setShowClearConfirm(true)} disabled={orders.length === 0} className={`bg-white p-4 rounded-xl border flex flex-col items-center justify-center transition-all flex-1 shadow-sm ${orders.length===0?'opacity-50 grayscale':'hover:bg-red-50 text-red-600'}`}>
                    <RotateCcw size={24}/><span className="mt-1 font-bold text-sm">清除今日所有訂單</span>
                  </button>
                )}
              </div>
            </div>
            
            <div className="bg-white rounded-xl border overflow-hidden shadow-sm">
              <div className="p-4 bg-gray-50 font-bold border-b flex items-center gap-2 text-gray-700"><ChefHat size={18}/> 飲料製作匯總</div>
              <div className="divide-y divide-gray-100">
                {Object.values(stats.itemStats).map((s, i) => (
                  <div key={i} className="p-4 hover:bg-gray-50 transition-colors">
                    <div className="flex justify-between font-bold mb-1"><span>{s.itemName}</span><span className="text-teal-600 text-xl">x {s.count}</span></div>
                    <div className="text-xs text-gray-500 bg-orange-50 p-3 rounded-lg border border-orange-100 shadow-inner space-y-1">{Object.entries(s.details).map(([n, c], j) => <div key={j} className="flex justify-between"><span>{n}</span><span>x {c}</span></div>)}</div>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white rounded-xl border overflow-hidden shadow-sm">
              <div className="p-4 bg-gray-50 font-bold border-b flex items-center gap-2 text-gray-700"><Users size={18}/> 個人清單 (管理員可修改)</div>
              <div className="divide-y divide-gray-100">
                {Object.values(stats.userTotals).map((u, i) => (
                  <div key={i} className="p-4">
                    <div className="flex justify-between font-bold text-teal-800 mb-2"><span>{u.name}</span><span className="text-red-500 font-mono">${u.total}</span></div>
                    <ul className="text-sm space-y-2">
                      {u.items.map(o => (
                        <li key={o.id} className="flex justify-between items-center text-gray-600 pl-2 border-l-2 border-teal-200 bg-gray-50/50 p-2 rounded">
                          <span className="flex-1">{o.item.name} <span className="text-[10px] text-gray-400 bg-gray-100 px-1 rounded ml-1 leading-none">{o.note}</span></span>
                          <div className="flex items-center gap-3">
                            <span className="font-medium text-gray-700">${o.price}</span>
                            {(currentUser === u.name || isAdmin) && (
                              <div className="flex gap-1">
                                <button onClick={()=>handleEditOrder(o)} className="p-1 hover:text-teal-600" title="修改"><Edit size={14}/></button>
                                <button onClick={()=>deleteDoc(doc(db,'artifacts',APP_ARTIFACT_ID,'public', 'data', 'orders',o.id))} className="p-1 hover:text-red-600" title="刪除"><Trash2 size={14}/></button>
                              </div>
                            )}
                          </div>
                        </li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {view === 'admin' && (
          <div className="space-y-6 animate-fade-in">
            <div className="bg-white p-6 rounded-xl border shadow-sm">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2 text-teal-800"><Sparkles className="text-purple-500"/> AI 快速建立店家</h2>
              <div className="space-y-4">
                <input type="text" value={newStoreName} onChange={e=>setNewStoreName(e.target.value)} placeholder="店家名稱" className="w-full p-2 border rounded focus:ring-2 focus:ring-purple-500 outline-none" />
                <div className="flex gap-2">
                  <input type="text" value={newStoreDescription} onChange={e=>setNewStoreDescription(e.target.value)} placeholder="介紹 (如：地址)" className="flex-1 p-2 border rounded text-sm focus:ring-2 focus:ring-purple-500 outline-none" />
                  <input type="text" value={newStoreUrl} onChange={e=>setNewStoreUrl(e.target.value)} placeholder="網址 (FB 粉專)" className="flex-1 p-2 border rounded text-sm focus:ring-2 focus:ring-purple-500 outline-none" />
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center relative hover:bg-gray-50 transition-colors">
                    <input type="file" multiple accept="image/*" onChange={e=>handleAIParse('image', e.target.files)} className="absolute inset-0 opacity-0 cursor-pointer" />
                    <ImageIcon size={32} className="mx-auto text-gray-400 mb-2" />
                    <p className="text-sm text-gray-500 font-medium">上傳菜單圖辨識</p>
                  </div>
                  <div className="flex flex-col gap-2">
                    <textarea value={menuInputText} onChange={e=>setMenuInputText(e.target.value)} placeholder="或貼上文字內容..." className="p-2 border rounded text-sm flex-1 focus:ring-2 focus:ring-purple-500 outline-none resize-none" />
                    <button onClick={()=>handleAIParse('text')} disabled={isAnalyzing} className="bg-purple-600 text-white py-2 rounded-lg font-bold flex justify-center items-center gap-2 hover:bg-purple-700 disabled:bg-gray-300 transition-colors shadow-sm shadow-purple-100">
                      {isAnalyzing ? <Loader2 className="animate-spin" size={16}/> : <Sparkles size={16}/>} 文字解析建立
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div className="bg-white p-6 rounded-xl border shadow-sm">
                <h2 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><List size={18}/> 店家管理</h2>
                <div className="space-y-3">
                  {stores.map(s => (
                    <div key={s.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg border hover:border-teal-300 transition-colors">
                      <div className="font-bold text-gray-700">{s.name} <span className="font-normal text-xs text-gray-400">({(s.items || []).length} 品項)</span></div>
                      <div className="flex gap-2">
                        <button onClick={()=>openEditStore(s)} className="p-2 text-gray-400 hover:bg-white hover:text-teal-600 rounded-full shadow-sm"><Edit size={18}/></button>
                        <button onClick={()=>setStoreToDelete(s)} className="p-2 text-gray-400 hover:bg-white hover:text-red-600 rounded-full shadow-sm"><Trash2 size={18}/></button>
                      </div>
                    </div>
                  ))}
                </div>
            </div>
          </div>
        )}
      </main>
      
      {/* Modal: Clear Orders Confirmation */}
      {showClearConfirm && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in">
          <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full text-center">
            <AlertTriangle className="mx-auto text-red-500 mb-4" size={48} />
            <h3 className="font-bold mb-2 text-lg text-gray-800">確定清除今日訂單？</h3>
            <p className="text-sm text-gray-400">此動作將會**永久刪除**目前所有的點單資料。此功能僅限管理員使用，適合下午茶結束後清空數據。</p>
            <div className="flex gap-3 mt-6">
              <button onClick={()=>setShowClearConfirm(false)} className="flex-1 p-2 bg-gray-100 rounded-lg font-bold transition-colors">取消</button>
              <button onClick={handleClearOrders} className="flex-1 p-2 bg-red-600 text-white rounded-lg font-bold shadow-lg shadow-red-100 hover:bg-red-700 transition-all">確定清空</button>
            </div>
          </div>
        </div>
      )}

      {/* Modal: Cart */}
      {cartItem && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center p-4 z-50">
          <div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
            <div className="p-4 bg-teal-50 border-b flex justify-between items-center">
              <h3 className="font-bold text-teal-800 flex items-center gap-2"><ShoppingBag size={18}/> {cartItem.isCustom ? '自訂內容' : cartItem.name}</h3>
              <button onClick={()=>{setCartItem(null); setEditingOrderId(null);}} className="p-1 hover:bg-teal-100 rounded-full"><X size={24}/></button>
            </div>
            <div className="p-6 space-y-5 max-h-[75vh] overflow-y-auto">
              {cartItem.isCustom && (
                <div className="flex gap-2 bg-gray-50 p-4 rounded-xl border border-gray-100">
                  <div className="flex-1"><label className="block text-xs font-bold text-gray-400 uppercase">品項名稱</label><input type="text" value={customItemName} onChange={e=>setCustomItemName(e.target.value)} className="w-full bg-transparent border-b border-gray-200 py-1 font-bold outline-none focus:border-teal-500" placeholder="例如：拿鐵" /></div>
                  <div className="w-24"><label className="block text-xs font-bold text-gray-400 uppercase">單價</label><input type="number" value={customItemPrice} onChange={e=>setCustomItemPrice(e.target.value)} className="w-full bg-transparent border-b border-gray-200 py-1 font-bold outline-none focus:border-teal-500 text-right" placeholder="0" /></div>
                </div>
              )}
              
              {!editingOrderId && (
                <div className="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-100">
                  <span className="text-sm font-bold text-gray-600">數量</span>
                  <div className="flex items-center gap-4">
                    <button onClick={()=>setCount(Math.max(1, count-1))} className="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm hover:bg-gray-100"><Minus size={16}/></button>
                    <span className="font-bold text-lg w-6 text-center">{count}</span>
                    <button onClick={()=>setCount(count+1)} className="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm hover:bg-gray-100"><Plus size={16}/></button>
                  </div>
                </div>
              )}

              {!cartItem.noSugar && (
                <div>
                  <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">糖度選項</label>
                  <div className="flex flex-wrap gap-2">{ currentSugarOptions.map(o=><button key={o} onClick={()=>setSugar(o)} className={`px-4 py-1.5 rounded-full text-xs border transition-all ${sugar===o?'bg-teal-600 text-white border-teal-600 shadow-md font-bold':'bg-white text-gray-500 hover:bg-gray-50'}`}>{o}</button>) }</div>
                </div>
              )}

              {!cartItem.noIce && (
                <div>
                  <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">冰塊選項</label>
                  <div className="flex flex-wrap gap-2">{ currentIceOptions.map(o=><button key={o} onClick={()=>setIce(o)} className={`px-4 py-1.5 rounded-full text-xs border transition-all ${ice===o?'bg-blue-600 text-white border-blue-600 shadow-md font-bold':'bg-white text-gray-500 hover:bg-gray-50'}`}>{o}</button>) }</div>
                </div>
              )}

              {currentToppings.length > 0 && (
                <div>
                  <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">加料區 (多選)</label>
                  <div className="grid grid-cols-2 gap-2">
                    {currentToppings.map(t=>(
                      <button key={t.id} onClick={()=>setSelectedToppings(p=>p.find(x=>x.id===t.id)?p.filter(x=>x.id!==t.id):[...p,t])} className={`p-3 border rounded-xl text-xs flex justify-between items-center transition-all ${selectedToppings.find(x=>x.id===t.id)?'bg-teal-50 border-teal-500 text-teal-700 font-bold shadow-sm':'bg-white text-gray-500 hover:bg-gray-50'}`}>
                        <span>{t.name}</span><span className="opacity-70">+${t.price}</span>
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {cartItem.allowNote !== false && (
                <div className="space-y-3">
                  {/* Individual Item Notes */}
                  <div>
                    <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">
                      品項備註 (加珍珠、換豆漿...)
                    </label>
                    <div className="space-y-2">
                      {Array.from({ length: count }).map((_, idx) => (
                        <div key={idx} className="flex items-center gap-2">
                          {count > 1 && <span className="text-xs text-gray-400 w-8">#{idx + 1}</span>}
                          <input 
                            type="text" 
                            value={individualItemNotes[idx] || ''} 
                            onChange={e => {
                              const newNotes = [...individualItemNotes];
                              newNotes[idx] = e.target.value;
                              setIndividualItemNotes(newNotes);
                            }}
                            placeholder={count > 1 ? `第 ${idx + 1} 杯備註...` : "輸入備註..."} 
                            className="w-full p-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-teal-500 bg-gray-50" 
                          />
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* General Order Note */}
                  <div>
                    <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">整體訂單備註 (給外送員/誰請客...)</label>
                    <input type="text" value={customNote} onChange={e=>setCustomNote(e.target.value)} placeholder="選填：額外說明..." className="w-full p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-teal-500" />
                  </div>
                </div>
              )}
              
              <button onClick={handleAddToCart} className="w-full bg-teal-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-teal-100 hover:bg-teal-700 active:scale-[0.98] transition-all mt-4">
                {editingOrderId ? '更新點單' : `確定加入訂單 $${estimatedPrice}`}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Modal: Store Edit */}
      {editingStore && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div className="p-4 bg-gray-100 border-b flex justify-between items-center font-bold text-gray-700">
              <h3>編輯店家與菜單資料</h3>
              <button onClick={()=>setEditingStore(null)}><X size={24}/></button>
            </div>
            <div className="p-6 overflow-y-auto flex-1 space-y-6">
              {/* 基本資訊區 */}
              <section className="space-y-4">
                <h4 className="font-bold text-teal-700 border-l-4 border-teal-600 pl-2 text-sm uppercase">基本資訊</h4>
                <input type="text" value={editingStore.name} onChange={e=>setEditingStore({...editingStore, name: e.target.value})} className="w-full p-2 border rounded font-bold outline-none focus:ring-2 focus:ring-teal-500" placeholder="店家名" />
                <div className="grid grid-cols-2 gap-3">
                  <input type="text" value={editingStore.description || ''} onChange={e=>setEditingStore({...editingStore, description: e.target.value})} className="p-2 border rounded text-sm" placeholder="介紹 (如：公休日)" />
                  <input type="text" value={editingStore.url || ''} onChange={e=>setEditingStore({...editingStore, url: e.target.value})} className="p-2 border rounded text-sm" placeholder="網址 (如：FB粉專)" />
                </div>
              </section>

              {/* AI 菜單查核驗證區 */}
              <section className="bg-purple-50 p-4 rounded-xl border border-purple-100 space-y-3">
                <div className="flex items-center justify-between">
                  <h4 className="font-bold text-purple-700 flex items-center gap-2 text-sm uppercase"><FileSearch size={18}/> AI 菜單查核驗證</h4>
                  <div className="text-[10px] text-purple-400 font-medium">利用網頁最新文字進行查核</div>
                </div>
                <div className="flex gap-2">
                  <textarea 
                    value={auditText} 
                    onChange={e=>setAuditText(e.target.value)} 
                    placeholder="請貼上該店點單網頁的品項文字內容，用來查核是否有新增或刪減的品項..." 
                    className="flex-1 p-2 border rounded text-xs min-h-[80px] focus:ring-2 focus:ring-purple-500 outline-none"
                  />
                  <button 
                    onClick={handleMenuAudit} 
                    disabled={isAuditing} 
                    className="bg-purple-600 text-white px-4 rounded-lg font-bold text-sm flex flex-col items-center justify-center gap-1 hover:bg-purple-700 disabled:bg-gray-300 min-w-[80px] shadow-sm"
                  >
                    {isAuditing ? <Loader2 className="animate-spin" size={20}/> : <ArrowRightLeft size={20}/>}
                    <span className="text-[10px]">{isAuditing ? '比對中' : '開始比對'}</span>
                  </button>
                </div>

                {auditResult && (
                  <div className="space-y-3 animate-fade-in">
                    {/* 新增品項查核結果 */}
                    {auditResult.added?.length > 0 && (
                      <div className="bg-white p-3 rounded-lg border border-green-200">
                        <h5 className="text-[10px] font-bold text-green-600 mb-2 flex items-center gap-1"><CheckCircle2 size={12}/> 發現網頁中有新增加的品項 ({auditResult.added.length})</h5>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {auditResult.added.map((item, idx) => (
                            <div key={idx} className="flex justify-between items-center bg-green-50/50 p-2 rounded text-xs border border-green-100">
                              <span>{item.name} (${item.price})</span>
                              <button onClick={()=>applyAuditItem(item, 'add')} className="text-green-600 hover:bg-green-100 p-1 rounded-full transition-colors"><Plus size={14}/></button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    {/* 消失品項查核結果 */}
                    {auditResult.removed?.length > 0 && (
                      <div className="bg-white p-3 rounded-lg border border-red-200">
                        <h5 className="text-[10px] font-bold text-red-600 mb-2 flex items-center gap-1"><AlertCircle size={12}/> 原菜單中有，但網頁文字中找不到的品項 ({auditResult.removed.length})</h5>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {auditResult.removed.map((item, idx) => (
                            <div key={idx} className="flex justify-between items-center bg-red-50/50 p-2 rounded text-xs border border-red-100 line-through text-gray-400">
                              <span>{item.name}</span>
                              <button onClick={()=>applyAuditItem(item, 'remove')} className="text-red-600 hover:bg-red-100 p-1 rounded-full transition-colors"><Trash2 size={14}/></button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    {auditResult.added?.length === 0 && auditResult.removed?.length === 0 && (
                      <div className="bg-white p-3 rounded-lg border border-gray-200 text-center text-xs text-gray-500 font-bold">
                        ✨ 查核完成！現有菜單與網頁文字內容完全一致。
                      </div>
                    )}
                  </div>
                )}
              </section>
              
              {/* 選項設定區 (糖、冰) */}
              <section className="grid grid-cols-2 gap-3">
                <div className="space-y-1"><label className="text-[10px] font-bold text-gray-400 uppercase">糖度選項 (逗號分隔)</label><input type="text" value={editingStore.sugarStr || ''} onChange={e=>setEditingStore({...editingStore, sugarStr: e.target.value})} className="w-full p-2 border rounded text-sm" /></div>
                <div className="space-y-1"><label className="text-[10px] font-bold text-gray-400 uppercase">冰塊選項 (逗號分隔)</label><input type="text" value={editingStore.iceStr || ''} onChange={e=>setEditingStore({...editingStore, iceStr: e.target.value})} className="w-full p-2 border rounded text-sm" /></div>
              </section>
              
              {/* 品項管理區 */}
              <section className="border-t pt-4">
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4 bg-gray-50 p-3 rounded-lg border">
                  <div className="font-bold text-teal-700 text-sm">品項細節快速設定</div>
                  <div className="flex flex-wrap gap-2">
                    <div className="flex gap-1 items-center bg-white p-1 rounded border shadow-sm">
                      <span className="text-[10px] text-gray-400 px-1 border-r mr-1">糖度</span>
                      <button onClick={()=>batchToggleItems('noSugar', false)} className="text-[10px] bg-orange-50 text-orange-600 px-2 py-1 rounded">全開</button>
                      <button onClick={()=>batchToggleItems('noSugar', true)} className="text-[10px] bg-gray-100 text-gray-400 px-2 py-1 rounded">全關</button>
                    </div>
                    <div className="flex gap-1 items-center bg-white p-1 rounded border shadow-sm">
                      <span className="text-[10px] text-gray-400 px-1 border-r mr-1">冰塊</span>
                      <button onClick={()=>batchToggleItems('noIce', false)} className="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded">全開</button>
                      <button onClick={()=>batchToggleItems('noIce', true)} className="text-[10px] bg-gray-100 text-gray-400 px-2 py-1 rounded">全關</button>
                    </div>
                  </div>
                </div>
                
                <div className="flex justify-between items-center mb-2">
                  <h5 className="font-bold text-xs text-gray-500 uppercase">品項清單 ({editingStore.items?.length || 0})</h5>
                  <button onClick={addEmptyItemToEditing} className="text-xs bg-teal-50 text-teal-600 px-2 py-1 rounded border border-teal-100 hover:bg-teal-100 font-bold">+ 手動新增品項</button>
                </div>

                <div className="space-y-2">
                  {(editingStore.items || []).map(item => (
                    <div key={item.id} className="flex flex-wrap gap-2 items-center bg-white p-2 rounded-lg border shadow-sm animate-fade-in">
                      <input type="text" value={item.name} onChange={e=>updateEditingItem(item.id, 'name', e.target.value)} className="flex-1 min-w-[120px] p-1 border rounded text-sm focus:ring-1 focus:ring-teal-500 outline-none" placeholder="品項名稱" />
                      <div className="w-16 relative"><span className="absolute left-1 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]">$</span><input type="number" value={item.price} onChange={e=>updateEditingItem(item.id, 'price', e.target.value)} className="w-full p-1 pl-3 border rounded text-xs text-right" /></div>
                      <div className="flex gap-1 items-center border-l pl-2 border-gray-100">
                        <button onClick={()=>updateEditingItem(item.id, 'noSugar', !item.noSugar)} className={`w-7 h-7 flex items-center justify-center rounded text-xs font-bold border ${!item.noSugar ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-gray-50 text-gray-300 border-gray-100'}`}>甜</button>
                        <button onClick={()=>updateEditingItem(item.id, 'noIce', !item.noIce)} className={`w-7 h-7 flex items-center justify-center rounded text-xs font-bold border ${!item.noIce ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-gray-50 text-gray-300 border-gray-100'}`}>冰</button>
                      </div>
                      <button onClick={()=>removeItemFromEditing(item.id)} className="text-gray-300 hover:text-red-500 p-1"><Trash2 size={16}/></button>
                    </div>
                  ))}
                </div>
              </section>

              {/* 加料區 */}
              <section className="border-t pt-4 space-y-2">
                <div className="flex justify-between items-center mb-2 font-bold text-orange-700 border-l-4 border-orange-600 pl-2 text-sm uppercase"><span>加料設定</span><button onClick={addToppingToEditing} className="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded border border-orange-100 font-bold">+ 新增加料</button></div>
                <div className="space-y-2">
                  {(editingStore.toppings || []).map(t => (
                    <div key={t.id} className="flex gap-2 items-center bg-orange-50/20 p-2 rounded border border-orange-100 shadow-sm">
                      <input type="text" value={t.name} onChange={e=>updateEditingTopping(t.id, 'name', e.target.value)} className="flex-1 p-1 border rounded text-sm" placeholder="配料名稱" />
                      <div className="w-20 relative"><span className="absolute left-1 top-1/2 -translate-y-1/2 text-orange-400 text-xs">$</span><input type="number" value={t.price} onChange={e=>updateEditingTopping(t.id, 'price', e.target.value)} className="w-full p-1 pl-4 border rounded text-sm text-right" /></div>
                      <button onClick={()=>removeToppingFromEditing(t.id)} className="text-gray-300 hover:text-red-500 p-1"><Trash2 size={16}/></button>
                    </div>
                  ))}
                </div>
              </section>
            </div>
            <div className="p-4 border-t bg-gray-100 flex justify-end gap-3 shadow-inner">
              <button onClick={()=>setEditingStore(null)} className="px-4 py-2 text-gray-500 font-bold hover:bg-gray-200 rounded-lg">取消</button>
              <button onClick={saveStoreChanges} className="bg-teal-600 text-white px-8 py-2 rounded-lg font-bold shadow-lg shadow-teal-100 hover:bg-teal-700 flex items-center gap-2 transition-all"><Save size={18}/> 儲存並更新店家資料</button>
            </div>
          </div>
        </div>
      )}

      {storeToDelete && (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full text-center">
            <AlertTriangle className="mx-auto text-red-500 mb-4" size={48} />
            <h3 className="font-bold mb-2 text-lg text-gray-800">確定刪除 {storeToDelete.name}？</h3>
            <p className="text-sm text-gray-400">刪除後該店家的所有點單明細也會一併消失。</p>
            <div className="flex gap-3 mt-6">
              <button onClick={()=>setStoreToDelete(null)} className="flex-1 p-2 bg-gray-100 rounded-lg font-bold transition-colors">取消</button>
              <button onClick={confirmDeleteStore} className="flex-1 p-2 bg-red-600 text-white rounded-lg font-bold shadow-lg shadow-red-100 hover:bg-red-700 transition-all">確認刪除</button>
            </div>
          </div>
        </div>
      )}

      {showAdminLogin && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-full animate-bounce-in">
            <div className="text-center mb-6">
                <div className="bg-teal-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-teal-600 mb-2 shadow-inner"><Lock size={32}/></div>
                <h3 className="font-bold text-xl">管理員驗證</h3>
                <p className="text-xs text-gray-400">請輸入密碼以存取店家與訂單設定</p>
            </div>
            <input type="password" value={adminPasswordInput} onChange={e=>setAdminPasswordInput(e.target.value)} className="w-full p-4 border rounded-xl mb-4 text-center tracking-[1em] text-2xl focus:ring-2 focus:ring-teal-500 outline-none shadow-sm font-mono" placeholder="••••" onKeyDown={e=>e.key==='Enter' && handleAdminLogin()}/>
            <button onClick={handleAdminLogin} className="w-full bg-teal-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-teal-100 hover:bg-teal-700 active:scale-95 transition-all">驗證登入</button>
            <button onClick={()=>setShowAdminLogin(false)} className="w-full text-gray-400 mt-4 text-sm font-medium hover:text-gray-600 transition-colors">返回首頁</button>
          </div>
        </div>
      )}

      {toast && <Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} />}
    </div>
  );
}
