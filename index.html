<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>辦公室下午茶點單系統</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .glass-morphism { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        body { background: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import ReactDOM from 'react-dom';
        import { 
            Coffee, Plus, Trash2, Edit3, Settings, LogIn, X, 
            CheckCircle, ChevronRight, BarChart2, FileDown, ShieldCheck, 
            Image as ImageIcon, Loader2, Save, ShoppingBag
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, onSnapshot, writeBatch } from 'firebase/firestore';

        // --- 設定區 ---
        const LIFF_ID = "2008746387-2t2kxxUX";
        const firebaseConfig = {
            apiKey: "AIzaSyBJeC5O1DF2VpvoSE8OKjtPT4wYPYec-Ok",
            authDomain: "office-tea-time.firebaseapp.com",
            projectId: "office-tea-time",
            storageBucket: "office-tea-time.firebasestorage.app",
            messagingSenderId: "771203264362",
            appId: "1:771203264362:web:cd47393dd73578b6ebbf13",
            measurementId: "G-R5SV13TYTE"
        };
        const GOOGLE_AI_API_KEY = "AIzaSyAHD7DXOusd8wrcitV1idnW0lvOWLFfstc"; // TODO: 填入你的 Google AI API Key

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'office-tea-system';

        // --- 子組件: 載入中動畫 ---
        const LoadingSpinner = () => (
            <div className="flex flex-col items-center justify-center p-12">
                <Loader2 className="w-10 h-10 animate-spin text-blue-500 mb-2" />
                <p className="text-gray-500">處理中，請稍候...</p>
            </div>
        );

        // --- 主要應用程式 ---
        function App() {
            const [user, setUser] = useState(null);
            const [lineProfile, setLineProfile] = useState(null);
            const [stores, setStores] = useState([]);
            const [orders, setOrders] = useState([]);
            const [view, setView] = useState('home'); 
            const [selectedStore, setSelectedStore] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);

            // [修正點] 初始化與身分驗證：移除導致錯誤的 Custom Token，改用穩定匿名登入
            useEffect(() => {
                const initApp = async () => {
                    // 初始化 LIFF
                    try {
                        if (typeof liff !== 'undefined') {
                            await liff.init({ liffId: LIFF_ID });
                            if (liff.isLoggedIn()) {
                                const profile = await liff.getProfile();
                                setLineProfile(profile);
                            }
                        }
                    } catch (err) { console.error("LIFF Init Error", err); }

                    // Firebase 匿名登入 (排除 Token Mismatch 錯誤)
                    try {
                        await signInAnonymously(auth);
                        console.log("Firebase 匿名驗證成功");
                    } catch (authErr) {
                        console.error("Firebase Auth Error", authErr);
                    }
                };
                initApp();

                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 監聽 Firestore 數據
            useEffect(() => {
                if (!user) return;
                
                const storesRef = collection(db, 'artifacts', appId, 'public', 'data', 'stores');
                const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');

                const unsubStores = onSnapshot(storesRef, (snapshot) => {
                    setStores(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => console.error("Stores fetch error", err));

                const unsubOrders = onSnapshot(ordersRef, (snapshot) => {
                    setOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (err) => console.error("Orders fetch error", err));

                return () => { unsubStores(); unsubOrders(); };
            }, [user]);

            const loginWithLine = () => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            };

            // AI 解析功能 (優化模型名稱)
            const parseMenuWithAI = async (text, images = []) => {
                if (!GOOGLE_AI_API_KEY) return alert("請先在程式碼中填入 Google AI API Key");
                setIsLoading(true);
                try {
                    const systemPrompt = `你是一個專業的菜單解析助理。請解析提供的文字或圖片中的飲料菜單。請以繁體中文回答。回傳格式必須為純 JSON。`;

                    let content = [{ text: text || "請解析圖片內容" }];
                    if (images.length > 0) {
                        for (const base64 of images) {
                            content.push({ inlineData: { mimeType: "image/png", data: base64.split(',')[1] } });
                        }
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GOOGLE_AI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: content }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    const result = await response.json();
                    const data = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    const storeRef = collection(db, 'artifacts', appId, 'public', 'data', 'stores');
                    await addDoc(storeRef, {
                        ...data,
                        createdAt: Date.now(),
                        settings: { showSugar: true, showIce: true, showNote: true }
                    });

                } catch (err) {
                    console.error("AI Parsing Error", err);
                    alert("解析失敗，請確認 API Key 或內容格式。");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleClearAllOrders = async () => {
                if (!window.confirm("確定要清除所有訂單嗎？")) return;
                const batch = writeBatch(db);
                orders.forEach(order => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id);
                    batch.delete(ref);
                });
                await batch.commit();
            };

            const exportCSV = () => {
                const headers = ["店家", "訂購人", "品項", "價格", "糖度", "冰塊", "備註"];
                const rows = orders.map(o => [
                    o.storeName, o.userName, o.itemName, o.price, o.sugar, o.ice, o.note
                ]);
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF" 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `訂單匯總_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- 視圖組件 ---
            const HomeView = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <Coffee className="text-orange-500" /> 店家清單
                        </h2>
                        <div className="flex gap-2">
                            {lineProfile && (
                                <button onClick={() => setView('admin')} className="p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">
                                    <Settings className="w-5 h-5 text-gray-600" />
                                </button>
                            )}
                            {!lineProfile ? (
                                <button onClick={loginWithLine} className="flex items-center gap-2 px-4 py-2 bg-[#06C755] text-white rounded-full font-medium shadow-md hover:opacity-90 transition-opacity">
                                    <LogIn size={18} /> LINE 登入
                                </button>
                            ) : (
                                <div className="flex items-center gap-2 bg-white p-1 pr-4 rounded-full shadow-sm border">
                                    <img src={lineProfile.pictureUrl} className="w-8 h-8 rounded-full" />
                                    <span className="text-sm font-medium">{lineProfile.displayName}</span>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {stores.length === 0 ? (
                            <div className="col-span-full p-12 text-center bg-white rounded-3xl border-2 border-dashed border-gray-200">
                                <p className="text-gray-400">目前還沒有店家，請登入管理員新增</p>
                            </div>
                        ) : (
                            stores.map(store => (
                                <div key={store.id} onClick={() => { setSelectedStore(store); setView('store-detail'); }} className="glass-morphism p-5 rounded-3xl cursor-pointer hover:shadow-xl transition-all border-b-4 border-orange-100 group">
                                    <div className="flex justify-between items-start mb-4">
                                        <div className="p-3 bg-orange-100 rounded-2xl text-orange-600 group-hover:scale-110 transition-transform">
                                            <ShoppingBag size={24} />
                                        </div>
                                        <span className="text-xs bg-orange-50 text-orange-600 px-2 py-1 rounded-full">
                                            {orders.filter(o => o.storeId === store.id).length} 筆點單
                                        </span>
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-1">{store.storeName}</h3>
                                    <p className="text-sm text-gray-500 flex items-center gap-1">查看菜單並點餐 <ChevronRight size={14} /></p>
                                </div>
                            ))
                        )}
                    </div>
                    <div className="fixed bottom-6 right-6">
                        <button onClick={() => setView('stats')} className="p-4 bg-white text-blue-600 rounded-full shadow-2xl hover:scale-110 transition-transform border border-blue-100">
                            <BarChart2 size={24} />
                        </button>
                    </div>
                </div>
            );

            // ... (其餘 StoreDetailView, AdminView, StatsView 邏輯保持不變) ...
            const StoreDetailView = () => {
                const [activeOrder, setActiveOrder] = useState(null);
                const [orderForm, setOrderForm] = useState({ sugar: '', ice: '', note: '' });
                const storeOrders = useMemo(() => orders.filter(o => o.storeId === selectedStore?.id), [orders, selectedStore]);

                const handlePlaceOrder = (item) => {
                    if (!lineProfile) return setShowAuthModal(true);
                    setActiveOrder(item);
                    setOrderForm({ sugar: selectedStore.options.sugar[0], ice: selectedStore.options.ice[0], note: '' });
                };

                const submitOrder = async () => {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                        storeId: selectedStore.id,
                        storeName: selectedStore.storeName,
                        itemName: activeOrder.name,
                        price: activeOrder.price,
                        ...orderForm,
                        lineUid: lineProfile.userId,
                        userName: lineProfile.displayName,
                        userPic: lineProfile.pictureUrl,
                        createdAt: Date.now()
                    });
                    setActiveOrder(null);
                };

                return (
                    <div className="space-y-6 animate-fade-in max-w-2xl mx-auto pb-24">
                        <button onClick={() => setView('home')} className="flex items-center gap-1 text-gray-500 hover:text-gray-800 transition-colors">
                            <ChevronRight className="rotate-180" size={18} /> 返回
                        </button>
                        <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                            <h2 className="text-2xl font-bold mb-4">{selectedStore?.storeName}</h2>
                            <div className="grid grid-cols-1 gap-3">
                                {selectedStore?.items.map((item, idx) => (
                                    <div key={idx} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                                        <div>
                                            <span className="font-medium">{item.name}</span>
                                            <p className="text-sm text-gray-500">${item.price}</p>
                                        </div>
                                        <button onClick={() => handlePlaceOrder(item)} className="bg-white p-2 rounded-xl shadow-sm hover:bg-orange-500 hover:text-white transition-all"><Plus /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        {activeOrder && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                                <div className="bg-white w-full max-w-md rounded-3xl p-6">
                                    <h3 className="text-xl font-bold mb-4">訂購：{activeOrder.name}</h3>
                                    <div className="space-y-4">
                                        <input type="text" placeholder="備註" value={orderForm.note} onChange={e=>setOrderForm({...orderForm, note: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" />
                                        <button onClick={submitOrder} className="w-full py-4 bg-orange-500 text-white rounded-2xl font-bold">送出</button>
                                        <button onClick={()=>setActiveOrder(null)} className="w-full py-2 text-gray-400">取消</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const AdminView = () => {
                const [pwd, setPwd] = useState('');
                const [isAuthed, setIsAuthed] = useState(isAdmin);
                const [menuInput, setMenuInput] = useState('');

                if (!isAuthed) {
                    return (
                        <div className="flex flex-col items-center p-12 bg-white rounded-3xl border">
                            <ShieldCheck className="w-16 h-16 text-blue-500 mb-4" />
                            <input type="password" value={pwd} onChange={e=>setPwd(e.target.value)} placeholder="密碼 (預設 8888)" className="p-3 border rounded-xl mb-4 text-center" />
                            <button onClick={() => pwd === '8888' ? (setIsAuthed(true), setIsAdmin(true)) : alert('錯誤')} className="px-8 py-3 bg-blue-600 text-white rounded-full">驗證</button>
                        </div>
                    );
                }
                return (
                    <div className="space-y-8 max-w-3xl mx-auto">
                        <div className="flex justify-between items-center">
                            <h2 className="text-2xl font-bold">管理後台</h2>
                            <button onClick={()=>setView('home')}><X/></button>
                        </div>
                        <div className="bg-white p-6 rounded-3xl border">
                            <textarea value={menuInput} onChange={e=>setMenuInput(e.target.value)} placeholder="貼上菜單文字..." className="w-full p-4 bg-gray-50 rounded-2xl min-h-[120px] mb-4" />
                            <button onClick={()=>parseMenuWithAI(menuInput)} disabled={isLoading} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold disabled:opacity-50">
                                {isLoading ? 'AI 解析中...' : 'AI 建立店家'}
                            </button>
                        </div>
                        <div className="bg-red-50 p-6 rounded-3xl border border-red-100">
                            <button onClick={handleClearAllOrders} className="px-6 py-3 bg-red-500 text-white rounded-2xl font-bold">一鍵清除所有訂單</button>
                        </div>
                    </div>
                );
            };

            const StatsView = () => (
                <div className="space-y-6 max-w-3xl mx-auto">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">統計匯總</h2>
                        <button onClick={()=>setView('home')}><X/></button>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-orange-500 text-white p-6 rounded-3xl">
                            <p className="text-sm opacity-80">總金額</p>
                            <h3 className="text-3xl font-bold">${orders.reduce((s,o)=>s+(o.price||0), 0)}</h3>
                        </div>
                        <div className="bg-blue-500 text-white p-6 rounded-3xl">
                            <p className="text-sm opacity-80">總杯數</p>
                            <h3 className="text-3xl font-bold">{orders.length}</h3>
                        </div>
                    </div>
                    <button onClick={exportCSV} className="w-full py-3 bg-gray-800 text-white rounded-xl flex items-center justify-center gap-2">
                        <FileDown size={18}/> 匯出 CSV 檔案
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-6xl mx-auto">
                    <header className="flex items-center justify-between mb-8">
                        <h1 className="text-3xl font-black text-gray-800 tracking-tight flex items-center gap-3">
                            <div className="bg-orange-500 text-white p-2 rounded-2xl rotate-3 shadow-lg"><Coffee /></div>
                            下午茶大隊
                        </h1>
                    </header>
                    {isLoading && <LoadingSpinner />}
                    {!isLoading && (
                        <>
                            {view === 'home' && <HomeView />}
                            {view === 'store-detail' && <StoreDetailView />}
                            {view === 'admin' && <AdminView />}
                            {view === 'stats' && <StatsView />}
                        </>
                    )}
                    {showAuthModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
                            <div className="bg-white p-8 rounded-[40px] shadow-2xl max-w-sm w-full text-center relative">
                                <button onClick={() => setShowAuthModal(false)} className="absolute top-6 right-6 text-gray-400"><X /></button>
                                <h3 className="text-2xl font-bold mb-2">需要登入</h3>
                                <p className="text-gray-500 mb-8">請先使用 LINE 登入系統才能進行點單。</p>
                                <button onClick={() => { loginWithLine(); setShowAuthModal(false); }} className="w-full py-4 bg-[#06C755] text-white rounded-3xl font-bold">使用 LINE 登入</button>
                            </div>
                        </div>
                    )}
                    <footer className="mt-20 py-8 text-center text-gray-400 text-xs">
                        &copy; 2025 Office Tea Ordering System.
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
