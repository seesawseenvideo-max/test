<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>辦公室下午茶點單系統 - AI 穩定版</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
  </script>

  <style>
    body { background-color: #f9fafb; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    @keyframes bounce-in { 0% { transform: scale(0.9); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
    .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { 
      Plus, Trash2, Coffee, Download, Users, List, Settings, 
      ShoppingBag, X, ChefHat, Check, Upload, Image as ImageIcon, 
      Loader2, Sparkles, Edit, Save, AlertTriangle, PenLine, Wifi, WifiOff, Lock, LogOut,
      Minus, Info, ExternalLink, Search, Square, CheckSquare, Eye, EyeOff, RotateCcw,
      ArrowRightLeft, FileSearch, CheckCircle2, AlertCircle
    } from 'lucide-react';
    
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, initializeFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from 'firebase/firestore';

    // ==========================================
    //  1. 設定區域 (LINE / Firebase / AI Keys)
    // ==========================================
    const LIFF_ID = "2008729022-PSf5NFFI";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBJeC5O1DF2VpvoSE8OKjtPT4wYPYec-Ok",
      authDomain: "office-tea-time.firebaseapp.com",
      projectId: "office-tea-time",
      storageBucket: "office-tea-time.firebasestorage.app",
      messagingSenderId: "771203264362",
      appId: "1:771203264362:web:cd47393dd73578b6ebbf13",
      measurementId: "G-R5SV13TYTE"
    };

    // 更新後的三組新金鑰
    const API_KEYS = [
      "AIzaSyC5cOL9suiO6LeTNi9_1jKAemT5DTnTnqE", 
      "AIzaSyByPp9L7eulgRCSwv5XrPyiSkKsCPHEvd4", 
      "AIzaSyBjRQBiQYoJGmhae2ONi-QskunwmQXjAi4"
    ];
    let currentKeyIndex = 0;

    const appId = 'my-office-tea-v1';
    const DEFAULT_SUGAR = ['正常糖', '少糖', '半糖', '微糖', '無糖', '無'];
    const DEFAULT_ICE = ['正常冰', '少冰', '微冰', '去冰', '溫', '熱', '無'];

    let app, auth, db;
    if (firebaseConfig.apiKey) {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = initializeFirestore(app, { experimentalForceLongPolling: true });
    }

    const Toast = ({ message, type, onClose }) => {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);
      const bgColors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
      return (
        <div className={`fixed bottom-4 right-4 ${bgColors[type] || 'bg-gray-800'} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-bounce-in z-50`}>
          <span>{message}</span>
        </div>
      );
    };

    function App() {
      const [liffLoading, setLiffLoading] = useState(true);
      const [lineProfile, setLineProfile] = useState(null);
      const [user, setUser] = useState(null);
      const [isOnline, setIsOnline] = useState(false);
      const [view, setView] = useState('order'); 
      const [stores, setStores] = useState([]); 
      const [orders, setOrders] = useState([]); 
      const [currentUser, setCurrentUser] = useState('');
      const [selectedStoreId, setSelectedStoreId] = useState(null);
      const [cartItem, setCartItem] = useState(null); 
      const [toast, setToast] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [newStoreName, setNewStoreName] = useState('');
      const [newStoreDescription, setNewStoreDescription] = useState('');
      const [newStoreUrl, setNewStoreUrl] = useState('');
      const [menuInputText, setMenuInputText] = useState('');
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [editingStore, setEditingStore] = useState(null);
      const [storeToDelete, setStoreToDelete] = useState(null);
      const [showClearConfirm, setShowClearConfirm] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false);
      const [showAdminLogin, setShowAdminLogin] = useState(false);
      const [adminPasswordInput, setAdminPasswordInput] = useState('');
      const [sugar, setSugar] = useState('正常糖');
      const [ice, setIce] = useState('正常冰');
      const [customNote, setCustomNote] = useState('');
      const [count, setCount] = useState(1);
      const [customItemName, setCustomItemName] = useState('');
      const [customItemPrice, setCustomItemPrice] = useState('');
      const [selectedToppings, setSelectedToppings] = useState([]);
      const [editingOrderId, setEditingOrderId] = useState(null);
      const [auditText, setAuditText] = useState('');
      const [isAuditing, setIsAuditing] = useState(false);
      const [auditResult, setAuditResult] = useState(null);

      const showToast = (msg, type = 'success') => setToast({ message: msg, type });

      // ==========================================
      //  2. AI 呼叫邏輯 (具備自動輪換金鑰)
      // ==========================================
      const callGeminiAI = async (prompt, imageParts = [], systemInstruction = "") => {
        const maxRetries = API_KEYS.length * 2;
        const delays = [1000, 2000, 4000];
        const defaultSystemPrompt = `你是一個專業的菜單助理。規則：回傳純 JSON 格式。`;
        
        for (let attempt = 0; attempt < maxRetries; attempt++) {
          const activeApiKey = API_KEYS[currentKeyIndex];
          try {
            const payload = { 
              contents: [{ parts: [{ text: prompt }, ...imageParts] }],
              systemInstruction: { parts: [{ text: systemInstruction || defaultSystemPrompt }] },
              generationConfig: { responseMimeType: "application/json", temperature: 0.1 }
            };

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${activeApiKey}`, {
              method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });

            const data = await res.json();
            
            if (data.error) {
              console.warn(`[Key Rotation] 金鑰 ${currentKeyIndex} 發生錯誤，正在切換...`);
              currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
              if (data.error.code === 429) {
                await new Promise(r => setTimeout(r, delays[attempt % delays.length]));
                continue; 
              }
              throw new Error(data.error.message);
            }

            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const cleanJson = text.replace(/```json|```/g, "").trim();
            return JSON.parse(cleanJson);

          } catch (e) { 
            console.error(`嘗試失敗:`, e.message);
            currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
            if (attempt === maxRetries - 1) throw e;
            await new Promise(r => setTimeout(r, 1000));
          }
        }
      };

      // --- 以下維持原有 App 邏輯 ---

      useEffect(() => {
        const initLiff = async () => {
          try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
              liff.login();
            } else {
              const profile = await liff.getProfile();
              setLineProfile(profile);
              setCurrentUser(profile.displayName);
              setLiffLoading(false);
            }
          } catch (err) {
            console.error('LIFF Error:', err);
            setLiffLoading(false);
          }
        };
        initLiff();
      }, []);

      const authInitiated = useRef(false);
      useEffect(() => {
        if (!auth || authInitiated.current) return;
        authInitiated.current = true;
        onAuthStateChanged(auth, (u) => {
          setUser(u);
          setIsOnline(!!u);
          if (!u) signInAnonymously(auth).catch(()=>{});
        });
      }, []);

      useEffect(() => {
        if (!user || !db) return;
        const storesQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'stores'));
        const unsubStores = onSnapshot(storesQuery, (snapshot) => {
          const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          loaded.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
          setStores(loaded);
          if (loaded.length > 0) {
            setSelectedStoreId(prev => loaded.find(s => s.id === prev) ? prev : loaded[0].id);
          }
        });
        const ordersQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'orders'));
        const unsubOrders = onSnapshot(ordersQuery, (snapshot) => {
          const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          loaded.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          setOrders(loaded);
        });
        return () => { unsubStores(); unsubOrders(); };
      }, [user]);

      useEffect(() => {
        if (cartItem && !editingOrderId) {
          setCount(1);
          setCustomNote('');
          setSelectedToppings([]);
          const store = stores.find(s => s.id === selectedStoreId);
          setSugar(store?.sugarOptions?.[0] || '正常糖');
          setIce(store?.iceOptions?.[0] || '正常冰');
        }
      }, [cartItem, selectedStoreId, stores, editingOrderId]);

      const parsePrice = (v) => typeof v === 'number' ? v : (parseFloat(String(v).match(/[0-9.]+/)) || 0);

      const handleAIParse = async (mode, files = null) => {
        if (!newStoreName.trim()) return showToast('請輸入店家名稱', 'error');
        if (mode === 'text' && !menuInputText.trim()) return showToast('請填寫文字', 'error');
        setIsAnalyzing(true);
        showToast('AI 正在讀取菜單...', 'info');
        try {
          let imageParts = [];
          if (mode === 'image' && files) {
            imageParts = await Promise.all(Array.from(files).map(f => new Promise((res) => {
              const r = new FileReader();
              r.onload = () => res({ inlineData: { mimeType: f.type, data: r.result.split(',')[1] } });
              r.readAsDataURL(f);
            })));
          }
          const queryMsg = mode === 'image' ? "分析菜單圖片" : `分析內容：\n${menuInputText}`;
          const systemPrompt = `你是一個專業的菜單助理。規則：1. 不翻譯名稱。2. 回傳 JSON 包含 items, toppings, sugarOptions, iceOptions。`;
          
          const result = await callGeminiAI(queryMsg, imageParts, systemPrompt);
          const tempStore = {
            name: newStoreName, description: newStoreDescription, url: newStoreUrl,
            items: (result.items || []).map((it, i) => ({ id: `ai-${Date.now()}-${i}`, name: it.name || "未命名", price: parsePrice(it.price), noSugar: false, noIce: false, allowNote: true })),
            toppings: (result.toppings || []).map((t, i) => ({ id: `ai-t-${Date.now()}-${i}`, name: t.name || "加料", price: parsePrice(t.price)})),
            sugarOptions: result.sugarOptions?.length ? result.sugarOptions : DEFAULT_SUGAR,
            iceOptions: result.iceOptions?.length ? result.iceOptions : DEFAULT_ICE,
            createdAt: Date.now()
          };
          const editState = JSON.parse(JSON.stringify(tempStore));
          editState.id = 'temp-new';
          editState.sugarStr = editState.sugarOptions.join(',');
          editState.iceStr = editState.iceOptions.join(',');
          setEditingStore(editState);
          setNewStoreName(''); setNewStoreDescription(''); setNewStoreUrl(''); setMenuInputText('');
          showToast('AI 解析完成！');
        } catch (e) { showToast(`解析失敗: ${e.message}`, 'error'); } finally { setIsAnalyzing(false); }
      };

      const handleMenuAudit = async () => {
        if (!auditText.trim()) return showToast('請貼上內容', 'error');
        setIsAuditing(true);
        showToast('查核比對中...', 'info');
        try {
          const currentItems = editingStore.items.map(i => ({ name: i.name, price: i.price }));
          const systemPrompt = `比對菜單差異。回傳 JSON: { added: [{name, price}], removed: [{name}] }`;
          const result = await callGeminiAI(`現有：${JSON.stringify(currentItems)}\n文字：${auditText}`, [], systemPrompt);
          setAuditResult(result);
          showToast('查核完成');
        } catch (e) { showToast('比對失敗', 'error'); } finally { setIsAuditing(false); }
      };

      const saveStoreChanges = async () => {
        if (!user || !db) return showToast('尚未連線', 'error');
        try {
          const sOpt = (editingStore.sugarStr || '').split(/[,\s，、]+/).map(s => s.trim()).filter(Boolean);
          const iOpt = (editingStore.iceStr || '').split(/[,\s，、]+/).map(s => s.trim()).filter(Boolean);
          const storeData = {
            name: editingStore.name, description: editingStore.description || '', url: editingStore.url || '',
            items: editingStore.items || [], toppings: editingStore.toppings || [],
            sugarOptions: sOpt.length ? sOpt : DEFAULT_SUGAR, iceOptions: iOpt.length ? iOpt : DEFAULT_ICE, updatedAt: Date.now()
          };
          if (editingStore.id === 'temp-new') {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'stores'), { ...storeData, createdAt: Date.now() });
          } else {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'stores', editingStore.id), storeData);
          }
          setEditingStore(null); showToast('儲存成功');
        } catch (e) { showToast('儲存失敗', 'error'); }
      };

      const handleAddToCart = async () => {
        if (!currentUser) return showToast('未取得身份', 'error');
        const name = cartItem.isCustom ? customItemName : cartItem.name;
        const price = Number(cartItem.isCustom ? customItemPrice : cartItem.price);
        try {
          const tNames = selectedToppings.map(t => `+${t.name}`).join(' ');
          const tPrice = selectedToppings.reduce((s, t) => s + Number(t.price || 0), 0);
          const finalNote = [(!cartItem.noSugar ? sugar : ''), (!cartItem.noIce ? ice : ''), tNames, customNote].filter(Boolean).join(' ');
          const finalUnitPrice = price + tPrice;
          if (editingOrderId) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingOrderId), { item: { name }, note: finalNote, price: finalUnitPrice });
            setEditingOrderId(null);
          } else {
            const batch = [];
            for (let i = 0; i < count; i++) {
              batch.push(addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), {
                userName: currentUser, storeId: selectedStoreId, storeName: stores.find(s => s.id === selectedStoreId)?.name,
                item: { name }, note: finalNote, price: finalUnitPrice, timestamp: new Date().toISOString()
              }));
            }
            await Promise.all(batch);
          }
          setCartItem(null); showToast('點單成功');
        } catch (e) { showToast("失敗", "error"); }
      };

      const stats = useMemo(() => {
        const uT = {}, iT = {}; let total = 0;
        orders.forEach(o => {
          total += o.price;
          if (!uT[o.userName]) uT[o.userName] = { name: o.userName, total: 0, items: [] };
          uT[o.userName].total += o.price; uT[o.userName].items.push(o);
          const k = `${o.storeName}-${o.item.name}`;
          if (!iT[k]) iT[k] = { storeName: o.storeName, itemName: o.item.name, count: 0, details: {} };
          iT[k].count++; iT[k].details[o.note || '無'] = (iT[k].details[o.note || '無'] || 0) + 1;
        });
        return { userTotals: uT, itemStats: iT, totalAmount: total };
      }, [orders]);

      const handleAdminLogin = () => {
        if (adminPasswordInput === '8888') {
          setIsAdmin(true); setShowAdminLogin(false); setView('admin'); showToast('管理員驗證成功');
        } else showToast('密碼錯誤', 'error');
      };

      const currentStore = stores.find(s => s.id === selectedStoreId);
      const estimatedPrice = cartItem ? (((Number(cartItem.isCustom ? customItemPrice : (cartItem.price || 0))) + selectedToppings.reduce((sum, t) => sum + Number(t.price || 0), 0)) * count) : 0;

      if (liffLoading) return (
        <div className="min-h-screen flex flex-col items-center justify-center bg-teal-50">
          <Loader2 className="animate-spin text-teal-600 mb-4" size={48} />
          <p className="text-teal-800 font-bold">系統初始化中...</p>
        </div>
      );

      return (
        <div className="min-h-screen bg-gray-50 text-gray-800 pb-20 md:pb-0">
          <header className={`text-white p-4 shadow-md sticky top-0 z-10 ${isOnline ? 'bg-teal-600' : 'bg-gray-600'}`}>
            <div className="max-w-4xl mx-auto flex justify-between items-center">
              <div className="flex items-center gap-3">
                {lineProfile?.pictureUrl ? <img src={lineProfile.pictureUrl} className="w-10 h-10 rounded-full" /> : <Coffee size={24}/>}
                <h1 className="text-lg font-bold">{lineProfile?.displayName || '下午茶系統'}</h1>
              </div>
              <div className="flex items-center gap-4">
                <span className="text-sm">今日額度: ${stats.totalAmount}</span>
                <button onClick={() => { liff.logout(); window.location.reload(); }}><LogOut size={18}/></button>
              </div>
            </div>
          </header>

          <main className="max-w-4xl mx-auto p-4">
            <div className="flex gap-2 mb-6 bg-white p-1 rounded-lg shadow-sm">
              {['order', 'stats', 'admin'].map(v => (
                <button key={v} onClick={() => (v==='admin' && !isAdmin) ? setShowAdminLogin(true) : setView(v)} className={`flex-1 py-2 px-4 rounded-md flex items-center justify-center gap-2 ${view===v ? 'bg-teal-100 text-teal-700 font-bold' : 'text-gray-500'}`}>
                  {v==='order' && <ShoppingBag size={18}/>}
                  {v==='stats' && <List size={18}/>}
                  {v==='admin' && <Settings size={18}/>}
                  <span>{v==='order'?'點餐':v==='stats'?'統計':'管理'}</span>
                </button>
              ))}
            </div>

            {view === 'order' && (
              <div className="space-y-6 animate-fade-in">
                {stores.length > 0 ? (
                  <>
                    <div className="flex overflow-x-auto gap-2 mb-4 pb-2 scrollbar-hide">
                      {stores.map(s => <button key={s.id} onClick={() => setSelectedStoreId(s.id)} className={`whitespace-nowrap px-4 py-2 rounded-full border ${selectedStoreId === s.id ? 'bg-teal-600 text-white' : 'bg-white'}`}>{s.name}</button>)}
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      <button onClick={()=>setCartItem({id:'custom', isCustom:true})} className="flex flex-col items-center justify-center p-4 bg-teal-50 border-2 border-dashed border-teal-300 rounded-xl text-teal-700 gap-2 min-h-[100px]"><PenLine size={24}/>自訂</button>
                      {(currentStore?.items || []).map(item => (
                        <button key={item.id} onClick={()=>setCartItem(item)} className="p-4 bg-white border rounded-xl hover:shadow-md text-left min-h-[100px] flex flex-col justify-between">
                          <span className="font-bold text-gray-800 line-clamp-2">{item.name}</span>
                          <span className="text-teal-600 font-bold">${item.price}</span>
                        </button>
                      ))}
                    </div>
                  </>
                ) : <div className="text-center py-20 text-gray-400">請由管理頁面新增店家</div>}
              </div>
            )}

            {view === 'stats' && (
              <div className="space-y-6 animate-fade-in">
                <div className="bg-white rounded-xl border p-4 space-y-4 shadow-sm">
                  <div className="flex justify-between items-center border-b pb-2">
                    <h3 className="font-bold flex items-center gap-2"><ChefHat size={18}/> 製作匯總</h3>
                    <button onClick={exportCSV} className="text-xs bg-teal-50 text-teal-600 px-2 py-1 rounded border border-teal-100">匯出 CSV</button>
                  </div>
                  <div className="divide-y">
                    {Object.values(stats.itemStats).map((s, i) => (
                      <div key={i} className="py-3">
                        <div className="flex justify-between font-bold"><span>{s.itemName}</span><span className="text-teal-600">x {s.count}</span></div>
                        <div className="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">
                          {Object.entries(s.details).map(([n, c], j) => <div key={j} className="flex justify-between"><span>{n}</span><span>x {c}</span></div>)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white rounded-xl border p-4 shadow-sm">
                  <h3 className="font-bold mb-4 flex items-center gap-2"><Users size={18}/> 個人清單</h3>
                  <div className="divide-y">
                    {Object.values(stats.userTotals).map((u, i) => (
                      <div key={i} className="py-3">
                        <div className="flex justify-between font-bold text-teal-800"><span>{u.name}</span><span>${u.total}</span></div>
                        <ul className="mt-2 text-sm text-gray-600 space-y-1">
                          {u.items.map(o => (
                            <li key={o.id} className="flex justify-between">
                              <span>{o.item.name} ({o.note})</span>
                              <div className="flex gap-2">
                                <span>${o.price}</span>
                                <button onClick={()=>deleteDoc(doc(db,'artifacts',appId,'public', 'data', 'orders',o.id))} className="text-red-400"><Trash2 size={14}/></button>
                              </div>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {view === 'admin' && (
              <div className="space-y-6 animate-fade-in">
                <div className="bg-white p-6 rounded-xl border shadow-sm space-y-4">
                  <h2 className="font-bold flex items-center gap-2"><Sparkles className="text-purple-500"/> AI 建立店家</h2>
                  <input type="text" value={newStoreName} onChange={e=>setNewStoreName(e.target.value)} placeholder="店家名稱" className="w-full p-2 border rounded" />
                  <div className="grid md:grid-cols-2 gap-4">
                    <div className="border-2 border-dashed rounded-xl p-8 text-center relative hover:bg-gray-50">
                      <input type="file" multiple accept="image/*" onChange={e=>handleAIParse('image', e.target.files)} className="absolute inset-0 opacity-0 cursor-pointer" />
                      <ImageIcon size={32} className="mx-auto text-gray-400 mb-2" />
                      <p className="text-sm text-gray-400">圖片解析菜單</p>
                    </div>
                    <div className="flex flex-col gap-2">
                      <textarea value={menuInputText} onChange={e=>setMenuInputText(e.target.value)} placeholder="貼上文字解析..." className="p-2 border rounded text-sm flex-1" />
                      <button onClick={()=>handleAIParse('text')} disabled={isAnalyzing} className="bg-purple-600 text-white py-2 rounded-lg font-bold">
                        {isAnalyzing ? <Loader2 className="animate-spin" size={16}/> : '文字解析'}
                      </button>
                    </div>
                  </div>
                </div>

                <div className="bg-white p-6 rounded-xl border shadow-sm">
                  <h2 className="font-bold mb-4">店家列表</h2>
                  <div className="space-y-2">
                    {stores.map(s => (
                      <div key={s.id} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                        <div className="font-bold">{s.name}</div>
                        <div className="flex gap-2">
                          <button onClick={()=>{const e = JSON.parse(JSON.stringify(s)); e.sugarStr = e.sugarOptions.join(','); e.iceStr = e.iceOptions.join(','); setEditingStore(e);}} className="p-2 text-teal-600"><Edit size={18}/></button>
                          <button onClick={()=>setStoreToDelete(s)} className="p-2 text-red-600"><Trash2 size={18}/></button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </main>

          {/* Modal: Cart */}
          {cartItem && (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
              <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in">
                <div className="p-4 bg-teal-50 flex justify-between items-center font-bold">
                  <h3>{cartItem.isCustom ? '自訂點單' : cartItem.name}</h3>
                  <button onClick={()=>{setCartItem(null); setEditingOrderId(null);}}><X size={24}/></button>
                </div>
                <div className="p-6 space-y-6">
                  {cartItem.isCustom && (
                    <div className="flex gap-2">
                      <input type="text" value={customItemName} onChange={e=>setCustomItemName(e.target.value)} className="flex-1 p-2 border rounded" placeholder="品項名稱" />
                      <input type="number" value={customItemPrice} onChange={e=>setCustomItemPrice(e.target.value)} className="w-24 p-2 border rounded" placeholder="價格" />
                    </div>
                  )}
                  <div>
                    <label className="text-xs text-gray-400 font-bold block mb-2">糖度</label>
                    <div className="flex flex-wrap gap-2">
                      {(currentStore?.sugarOptions || DEFAULT_SUGAR).map(o=><button key={o} onClick={()=>setSugar(o)} className={`px-4 py-1 rounded-full border text-xs ${sugar===o?'bg-teal-600 text-white':'bg-white'}`}>{o}</button>)}
                    </div>
                  </div>
                  <div>
                    <label className="text-xs text-gray-400 font-bold block mb-2">冰塊</label>
                    <div className="flex flex-wrap gap-2">
                      {(currentStore?.iceOptions || DEFAULT_ICE).map(o=><button key={o} onClick={()=>setIce(o)} className={`px-4 py-1 rounded-full border text-xs ${ice===o?'bg-blue-600 text-white':'bg-white'}`}>{o}</button>)}
                    </div>
                  </div>
                  <input type="text" value={customNote} onChange={e=>setCustomNote(e.target.value)} placeholder="備註..." className="w-full p-2 border rounded-lg" />
                  <button onClick={handleAddToCart} className="w-full bg-teal-600 text-white py-4 rounded-xl font-bold shadow-lg">
                    送出點單 (${estimatedPrice})
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Modal: Admin Login */}
          {showAdminLogin && (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 max-w-sm w-full text-center space-y-6 animate-bounce-in">
                <Lock className="mx-auto text-teal-600" size={48} />
                <h3 className="font-bold text-xl">管理員驗證</h3>
                <input type="password" value={adminPasswordInput} onChange={e=>setAdminPasswordInput(e.target.value)} className="w-full p-4 border rounded-xl text-center text-2xl tracking-widest" placeholder="••••" onKeyDown={e=>e.key==='Enter' && handleAdminLogin()}/>
                <button onClick={handleAdminLogin} className="w-full bg-teal-600 text-white py-4 rounded-xl font-bold">驗證</button>
                <button onClick={()=>setShowAdminLogin(false)} className="text-gray-400 text-sm">取消</button>
              </div>
            </div>
          )}

          {toast && <Toast message={toast.message} type={toast.type} onClose={()=>setToast(null)} />}
        </div>
      );
    }

    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>

