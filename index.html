<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>辦公室下午茶點單系統 - AI 穩定版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
  </script>
  <style>
    body { background-color: #f9fafb; font-family: sans-serif; }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Plus, Trash2, Coffee, Download, Users, List, Settings, ShoppingBag, X, ChefHat, Check, Image as ImageIcon, Loader2, Sparkles, Edit, Save, AlertTriangle, PenLine, Lock, LogOut, Minus, Info, Search, RotateCcw, ArrowRightLeft, FileSearch } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, initializeFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from 'firebase/firestore';

    // ==========================================
    // 1. 安全設定區 (請在本地替換金鑰)
    // ==========================================
    const API_KEYS = [
      "AIzaSyBjRQBiQYoJGmhae2ONi-QskunwmQXjAi4", // 填入你的新金鑰 1
      "AIzaSyByPp9L7eulgRCSwv5XrPyiSkKsCPHEvd4", // 填入你的新金鑰 2
      "AIzaSyC5cOL9suiO6LeTNi9_1jKAemT5DTnTnqE"  // 填入你的新金鑰 3
    ];
    let currentKeyIndex = 0;

    const LIFF_ID = "2008729022-PSf5NFFI";
    const firebaseConfig = {
      apiKey: "AIzaSyBJeC5O1DF2VpvoSE8OKjtPT4wYPYec-Ok",
      authDomain: "office-tea-time.firebaseapp.com",
      projectId: "office-tea-time",
      appId: "1:771203264362:web:cd47393dd73578b6ebbf13"
    };

    // ==========================================
    // 2. AI 呼叫邏輯 (2025 穩定版本)
    // ==========================================
    const callGeminiAI = async (prompt, imageParts = [], systemInstruction = "") => {
      const maxRetries = API_KEYS.length * 2;
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        const activeApiKey = API_KEYS[currentKeyIndex];
        if (activeApiKey.includes("YOUR_NEW")) throw new Error("尚未替換 API 金鑰！");

        try {
          const payload = { 
            contents: [{ parts: [{ text: prompt }, ...imageParts] }],
            system_instruction: { // 2025 標準 REST 格式
              parts: [{ text: systemInstruction || "你是一個專業菜單助理，請分析內容並回傳純 JSON 格式。" }] 
            },
            generationConfig: { 
              responseMimeType: "application/json", // 強制輸出 JSON
              temperature: 0.1 
            }
          };

          // 使用 v1 穩定版與最新的 gemini-2.5-flash 模型
          const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${activeApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          if (!res.ok) {
            console.warn(`Key ${currentKeyIndex} 報錯:`, data.error?.message);
            currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
            continue;
          }

          const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
          return JSON.parse(text.replace(/```json|```/g, "").trim());
        } catch (e) {
          currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
          if (attempt === maxRetries - 1) throw e;
          await new Promise(r => setTimeout(r, 1000));
        }
      }
    };

    // --- 以下為 App 主程式邏輯 (簡化版確保穩定運作) ---

    function App() {
      const [liffLoading, setLiffLoading] = useState(true);
      const [lineProfile, setLineProfile] = useState(null);
      const [view, setView] = useState('order'); 
      const [stores, setStores] = useState([]); 
      const [orders, setOrders] = useState([]);
      const [currentUser, setCurrentUser] = useState('');
      const [selectedStoreId, setSelectedStoreId] = useState(null);
      const [cartItem, setCartItem] = useState(null); 
      const [toast, setToast] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [newStoreName, setNewStoreName] = useState('');
      const [sugar, setSugar] = useState('正常糖');
      const [ice, setIce] = useState('正常冰');

      const db = useMemo(() => initializeFirestore(initializeApp(firebaseConfig), { experimentalForceLongPolling: true }), []);
      const showToast = (msg, type = 'success') => setToast({ message: msg, type });

      useEffect(() => {
        liff.init({ liffId: LIFF_ID }).then(() => {
          if (!liff.isLoggedIn()) liff.login();
          else liff.getProfile().then(p => { setLineProfile(p); setCurrentUser(p.displayName); setLiffLoading(false); });
        }).catch(() => setLiffLoading(false));
      }, []);

      useEffect(() => {
        const unsubS = onSnapshot(collection(db, 'artifacts', 'my-office-tea-v1', 'public', 'data', 'stores'), s => {
          const l = s.docs.map(d => ({ id: d.id, ...d.data() }));
          setStores(l); if (l.length > 0) setSelectedStoreId(l[0].id);
        });
        const unsubO = onSnapshot(collection(db, 'artifacts', 'my-office-tea-v1', 'public', 'data', 'orders'), s => {
          setOrders(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => { unsubS(); unsubO(); };
      }, [db]);

      const handleAIParse = async () => {
        if (!newStoreName) return showToast('請輸入店家名', 'error');
        setIsAnalyzing(true);
        try {
          const result = await callGeminiAI(`分析菜單文字：\n${newStoreName}`);
          // 這裡實作將解析結果存入 Firebase 的邏輯
          showToast('AI 解析成功！');
        } catch (e) { showToast('解析失敗', 'error'); } finally { setIsAnalyzing(false); }
      };

      if (liffLoading) return <div className="h-screen flex items-center justify-center">驗證中...</div>;

      return (
        <div className="max-w-4xl mx-auto p-4 space-y-4">
          <header className="bg-teal-600 text-white p-4 rounded-xl flex justify-between items-center shadow-lg">
            <div className="flex items-center gap-2"><Coffee /> <span className="font-bold">{currentUser} 的下午茶</span></div>
            <button onClick={() => setView(view === 'admin' ? 'order' : 'admin')} className="p-2 bg-white/20 rounded-lg"><Settings size={18}/></button>
          </header>

          {view === 'order' ? (
            <div className="animate-fade-in space-y-4">
               <div className="grid grid-cols-2 gap-3">
                 {stores.map(s => (
                   <button key={s.id} onClick={() => setSelectedStoreId(s.id)} className={`p-4 rounded-xl border-2 transition-all ${selectedStoreId === s.id ? 'border-teal-500 bg-teal-50' : 'bg-white'}`}>
                     <div className="font-bold text-teal-800">{s.name}</div>
                   </button>
                 ))}
               </div>
            </div>
          ) : (
            <div className="animate-fade-in bg-white p-6 rounded-xl border shadow-sm space-y-4">
              <h2 className="font-bold text-lg">新增店家 (AI 模式)</h2>
              <input value={newStoreName} onChange={e=>setNewStoreName(e.target.value)} className="w-full p-2 border rounded" placeholder="貼上菜單文字或名稱" />
              <button onClick={handleAIParse} disabled={isAnalyzing} className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2">
                {isAnalyzing ? <Loader2 className="animate-spin" /> : <Sparkles />} 開始 AI 辨識
              </button>
            </div>
          )}
          
          {toast && <div className={`fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg ${toast.type === 'error' ? 'bg-red-500' : 'bg-teal-600'}`}>{toast.message}</div>}
        </div>
      );
    }
    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
