<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>下午茶點單系統 - AI 穩定修復版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
  </script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import { Plus, Trash2, Coffee, Settings, ShoppingBag, X, ChefHat, Loader2, Sparkles, Edit, Lock, LogOut, Minus, Search, RotateCcw } from 'lucide-react';
    import { initializeApp } from 'firebase/app';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
    import { getFirestore, initializeFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from 'firebase/firestore';

    // ==========================================
    // 1. 金鑰填寫區 (請在此替換為截圖中的新金鑰)
    // ==========================================
    const API_KEYS = [
      "AIzaSyC5cOL9suiO6LeTNi9_1jKAemT5DTnTnqE", // 金鑰 1 (teatime1)
      "AIzaSyByPp9L7eulgRCSwv5XrPyiSkKsCPHEvd4", // 金鑰 2 (teatime2)
      "AIzaSyBjRQBiQYoJGmhae2ONi-QskunwmQXjAi4"  // 金鑰 3 (teatime3)
    ];
    let currentKeyIndex = 0;

    const LIFF_ID = "2008729022-PSf5NFFI";
    const firebaseConfig = {
      apiKey: "AIzaSyBJeC5O1DF2VpvoSE8OKjtPT4wYPYec-Ok",
      authDomain: "office-tea-time.firebaseapp.com",
      projectId: "office-tea-time",
      appId: "1:771203264362:web:cd47393dd73578b6ebbf13"
    };

    // ==========================================
    // 2. 修復後的 AI 呼叫邏輯 (使用 v1 穩定版)
    // ==========================================
    const callGeminiAI = async (prompt, imageParts = [], systemInstruction = "") => {
      const maxRetries = API_KEYS.length * 2;
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        const activeApiKey = API_KEYS[currentKeyIndex];
        
        try {
          const payload = { 
            contents: [{ parts: [{ text: prompt }, ...imageParts] }],
            system_instruction: { 
              parts: [{ text: systemInstruction || "你是一個專業菜單助理，請分析內容並回傳純 JSON 格式。" }] 
            },
            generationConfig: { 
              responseMimeType: "application/json", 
              temperature: 0.1 
            }
          };

          // 核心修復：改用 v1 穩定版網址與正確模型名稱
          const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${activeApiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          
          if (!res.ok) {
            console.error(`Key ${currentKeyIndex} 失效，訊息:`, data.error?.message);
            currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
            continue; // 自動換下一組金鑰
          }

          const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
          return JSON.parse(text.replace(/```json|```/g, "").trim());

        } catch (e) {
          currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
          if (attempt === maxRetries - 1) throw e;
          await new Promise(r => setTimeout(r, 1000));
        }
      }
    };

    // --- 主程式其餘部分保持原本邏輯 ---
    function App() {
      const [liffLoading, setLiffLoading] = useState(true);
      const [lineProfile, setLineProfile] = useState(null);
      const [view, setView] = useState('order'); 
      const [stores, setStores] = useState([]); 
      const [orders, setOrders] = useState([]);
      const [currentUser, setCurrentUser] = useState('');
      const [selectedStoreId, setSelectedStoreId] = useState(null);
      const [toast, setToast] = useState(null);
      const [isAdmin, setIsAdmin] = useState(false);
      const [isAnalyzing, setIsAnalyzing] = useState(false);
      const [newStoreName, setNewStoreName] = useState('');

      const app = initializeApp(firebaseConfig);
      const db = initializeFirestore(app, { experimentalForceLongPolling: true });
      const showToast = (msg, type = 'success') => setToast({ message: msg, type });

      useEffect(() => {
        liff.init({ liffId: LIFF_ID }).then(() => {
          if (!liff.isLoggedIn()) liff.login();
          else liff.getProfile().then(p => { setLineProfile(p); setCurrentUser(p.displayName); setLiffLoading(false); });
        }).catch(() => setLiffLoading(false));
      }, []);

      useEffect(() => {
        if (!db) return;
        const unsubS = onSnapshot(collection(db, 'artifacts', 'my-office-tea-v1', 'public', 'data', 'stores'), s => {
          const l = s.docs.map(d => ({ id: d.id, ...d.data() }));
          setStores(l); if (l.length > 0 && !selectedStoreId) setSelectedStoreId(l[0].id);
        });
        const unsubO = onSnapshot(collection(db, 'artifacts', 'my-office-tea-v1', 'public', 'data', 'orders'), s => {
          setOrders(s.docs.map(d => ({ id: d.id, ...d.data() })));
        });
        return () => { unsubS(); unsubO(); };
      }, [db]);

      const handleAIParse = async () => {
        if (!newStoreName) return showToast('請輸入菜單文字', 'error');
        setIsAnalyzing(true);
        showToast('AI 正在讀取...', 'info');
        try {
          const result = await callGeminiAI(`分析這段文字並整理成飲品名稱與價格的 JSON 列表：\n${newStoreName}`);
          console.log("解析結果:", result);
          showToast('AI 解析成功！');
        } catch (e) { 
          showToast('解析出錯，請檢查 F12 Network', 'error'); 
        } finally { 
          setIsAnalyzing(false); 
        }
      };

      if (liffLoading) return <div className="h-screen flex items-center justify-center font-bold text-teal-600">驗證中...</div>;

      return (
        <div className="max-w-md mx-auto min-h-screen flex flex-col p-4 space-y-4">
          <header className="bg-teal-600 text-white p-4 rounded-2xl flex justify-between items-center shadow-lg">
            <div className="flex items-center gap-2"><Coffee /> <span className="font-bold">{currentUser}</span></div>
            <button onClick={() => setView(view === 'admin' ? 'order' : 'admin')} className="p-2 bg-white/20 rounded-xl"><Settings size={20}/></button>
          </header>

          {view === 'order' ? (
            <div className="space-y-4">
               <div className="flex gap-2 overflow-x-auto pb-2">
                 {stores.map(s => (
                   <button key={s.id} onClick={() => setSelectedStoreId(s.id)} className={`px-4 py-2 rounded-full whitespace-nowrap border-2 transition-all ${selectedStoreId === s.id ? 'border-teal-500 bg-teal-50 text-teal-700 font-bold' : 'bg-white border-gray-200 text-gray-400'}`}>
                     {s.name}
                   </button>
                 ))}
               </div>
               <div className="bg-white p-8 rounded-3xl border-2 border-dashed border-gray-200 text-center text-gray-400">
                 點擊上方店家開始點餐
               </div>
            </div>
          ) : (
            <div className="bg-white p-6 rounded-3xl border shadow-sm space-y-4">
              <h2 className="font-bold text-xl text-gray-800 flex items-center gap-2"><Sparkles className="text-purple-500"/> AI 菜單解析</h2>
              <textarea value={newStoreName} onChange={e=>setNewStoreName(e.target.value)} className="w-full p-4 border rounded-2xl bg-gray-50 h-40 outline-none focus:ring-2 focus:ring-purple-400" placeholder="貼上菜單文字內容..." />
              <button onClick={handleAIParse} disabled={isAnalyzing} className="w-full bg-purple-600 text-white py-4 rounded-2xl font-bold flex justify-center items-center gap-2 shadow-lg active:scale-95 transition-all">
                {isAnalyzing ? <Loader2 className="animate-spin" /> : <Sparkles />} 開始 AI 解析
              </button>
            </div>
          )}
          
          {toast && <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 text-white px-8 py-4 rounded-2xl shadow-2xl font-bold z-50 ${toast.type === 'error' ? 'bg-red-500' : 'bg-teal-600'}`}>{toast.message}</div>}
        </div>
      );
    }
    createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
